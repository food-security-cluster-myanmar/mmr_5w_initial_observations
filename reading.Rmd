---
title: "Untitled"
output: html_document
---

### Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(pander)
library(janitor)
library(fuzzyjoin)
library(scales)
library(magrittr)
library(sf)
library(bookdown)
library(data.table)
library(plotly)

theme_set(theme_light())

# disabling scientific notation
options(scipen = 100)

# pander tables all in one row
panderOptions('table.split.table', Inf)

# pander thousands separator
panderOptions("big.mark", ",")

`%out%` <- Negate(`%in%`)

# function for transposing df
transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}

# function beneficiary summaries
fscben <- function(df, column_var){
  
  column_var <- enquo(column_var)
  
  df %>%
    group_by(!!column_var) %>% # must add bang-bang
    summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
    arrange(desc(beneficiaries))
    
 }

```

### MMR township data and state_region data 

> The mmr dataset is a long dataframe of all available indicators from MIMU at the township level 

```{r}
mmr_ts <- read_excel("MIMU_BaselineData_AllSectors_Countrywide_18Mar2021_revised.xlsm",
                  sheet = "Township",
                  skip = 5) %>% 
  janitor::clean_names() %>% 
  pivot_longer(cols = starts_with("x"), names_to = "year", values_to = "value", values_drop_na = TRUE) %>% 
  mutate(year = str_replace_all(year, "x", ""))%>%
  rename(years = year) %>% 
  mutate(year = substr(years, nchar(years) - 3, nchar(years))) # year is now most-recent year
  

mmr_sr <- read_excel("MIMU_BaselineData_AllSectors_Countrywide_18Mar2021_revised.xlsm",
                  sheet = "State_Region",
                  skip = 5) %>% 
  janitor::clean_names() %>% 
  pivot_longer(cols = starts_with("x"), names_to = "year", values_to = "value", values_drop_na = TRUE) %>% 
  mutate(year = str_replace_all(year, "x", ""))

```

```{r}
glimpse(mmr)

mmr %>% count(source_name, sort = TRUE)

mmr %>% 
  filter(source_name == "MMR_MOH/DHP, Township Health Profile") %>% 
  count(year)

mmr %>% filter(str_detect(indicator_name, "hard"))

mmr %>%  count(indicator_name)

mmr %>% 
  count(state_region, township_pcode, sort = TRUE)

sum(is.character(mmr$township_pcode))

mmr %>% count(year, sort = TRUE)

# extract last four digits to mutate a new column -- year_last

mmr %>%
  rename(years = year) %>% 
  mutate(year = substr(years, nchar(years) - 3, nchar(years)))

mmr %>% 
  count(year)

```

```{r}
mmr %>% 
  count(year)

mmr %>% filter(year == "2020") %>% 
  select(indicator_name, source_name) %>% distinct()
```


### Population estimates

```{r}

# latest population counts are from GAD 2018?

mmr %>% 
  filter(source_name == "General Administration Department (GAD) Township Profile" &
           indicator_name == "Population size") %>% 
  count(year, sort = TRUE)


mmr %>% filter(sub_sector == "Population" &
                 year == "2019") 

# sr_pop are the inter-censal survey estimates, the figures from mmr are from the
# GAD township profiles 

sr_pop <- mmr_sr %>% filter(year == "2019") %>% 
  filter(indicator_name == "Population size")

# GAD township population counts vs inter-censal survey
# which figures are we using for estimations? 

mmr %>% filter(indicator_name == "Population size" &
                 year == "2019") %>% 
  group_by(state_region) %>% 
  summarise(population = sum(value)) %>%
  add_row(state_region = "Bago", population = 2660955 + 1937499) %>% 
  filter(state_region != "Bago (East)" &
         state_region != "Bago (West)") %>% 
  left_join(sr_pop %>%
              filter(indicator_type == "Total") %>%
              mutate(value = value * 1000) %>%
              select(state_region, value)) %>% 
  mutate(difference = population - value) %>% 
  rename(population_GAD = population, 
         population_ICS = value) %>% 
  arrange(desc(abs(difference)))


```


### Vulnerability in Myanmar dataset

```{r message=FALSE, warning=FALSE}


# indicator guide for vulmmr
indicator_guide <- read_excel("Datasets_Vulnerability_Analysis_in_Myanmar_09Jul2018 (1).xlsx",
           skip = 1) %>% 
  slice(1:3) %>% 
  janitor::clean_names() %>% 
  transpose_df() %>% 
  rename(indicator = rowname, 
         age_group = `1`,
         category = `2`, 
         source = `3`) %>% 
  slice(-1)

# reading in vulnerability dataset
vulmmr <- read_excel("Datasets_Vulnerability_Analysis_in_Myanmar_09Jul2018 (1).xlsx",
           skip = 1) %>% 
  slice(-c(1:3)) %>% 
  clean_names() %>% 
  select(-label) %>% 
  mutate_at(vars(number_of_village_tracts:wb_wealth_rank), as.numeric) %>% 
  mutate_at(vars(disasters_impacted_by_nargis_2008:acled_2015_2016_data_exists), as.logical) %>% 
  mutate_at(vars(conflict_2015_2016_number_of_battles:corrected_conflict_index_garry), as.numeric) %>% 
  select(-starts_with("x")) %>% 
  select(-c(private_sector_development_2014_2015, protection_2010_2015, shelter_2010_2015, wash_2010_2015))

```



```{r}

vulmmr %>%  
  filter(str_detect(indicator, "vulner|wellbeing")) %>% 
  select(indicator) %>% distinct() %>% pull() %>% as.vector()

vulmmr  %>%  filter(township_name == "Hakha") %>% 
  filter(category == "Agriculture") %>%
  
  filter(str_detect(indicator, "sown")) %>% 
  arrange(desc(value))

# I guess you don't really need this anymore since you have the categories 

```

### Geoadmins and location dataset

```{r}

geoadmins <- read_excel("FSC 5W 2021 - GEOADMINS_final 19.xlsx",
           sheet = "GEOADMINS") %>% 
  clean_names() 

townships <- geoadmins %>% 
  select(admin1pcode_4:admin3pcode) %>% 
  rename(admin1_pcode = admin1pcode_4,
         admin3_pcode = admin3pcode,
         state_name   = state_5,
         township_name  = county) %>% 
  remove_empty()

payams <- geoadmins %>%  
  select(state_name:payam_code) %>% 
  rename(admin1_pcode = state_code_12,
         township_name = county_name, 
         admin3_pcode = county_code,
         location = payam_name) %>%
  remove_empty() %>% 
  mutate(location_type = paste0("payam")) 
  

camps <- geoadmins %>% 
  select(county_name1:p_code_camp) %>% 
  rename(township_name = county_name1,
         admin3_pcode = state_code_23,
         location = camps, 
         camp_pcode = p_code_camp) %>% 
  remove_empty() %>% 
  mutate(location_type = paste0("camp")) %>% 
  left_join(townships %>% select(state_name, admin1_pcode, admin3_pcode), 
            by = c("admin3_pcode")) %>% 
  relocate(admin1_pcode) %>% 
  relocate(state_name)

# fuzzy joins has been done, now we just need to manually fill in the rest
# you're almost done here. 

industrial_zones <- geoadmins %>% 
  select(state_28:industrial_zones) %>% 
  rename(state_name = state_28, 
         admin1_pcode = admin1pcode_29,
         location = industrial_zones) %>%
  remove_empty() %>% 
  regex_left_join(townships %>% select(township_name, admin3_pcode),
                  by = c("location" = "township_name")) %>% 
  # replacing the NAs with 0s so the filter doesn't drop them 
  replace_na(list(township_name = 0, admin3_pcode = 0, admin1_pcode = 0)) %>%
  filter(admin3_pcode != "MMR013040") %>% # removing all the matches between Hlaingtharya and Hlaing
  filter(admin3_pcode != "MMR011006") %>% # removing all the matches between Yenangyaung and Ye
  mutate(location_type = paste0("industrial_zone"))

# writing the locations dataset

locations <- bind_rows(payams, camps, industrial_zones) %>%
  mutate(location_code = case_when(location_type == "camp" ~ camp_pcode,
                                   location_type == "payam" ~ payam_code,
                                   location_type == "industrial_zone" ~ NA_character_)) %>%
  mutate(locations_fuzzy = str_replace_all(location, "[[:punct:]]", ""))

```

```{r}

punctuation <- "a1~!@#$%^&*(){}_+:\"<>?,./;'[]-="
         
locations %>% select(locations_fuzzy)

locations %>% filter(location_type == "industrial_zone")

```


```{r}
vulmmr %>% select(state_region_name, township_name) %>% 
  distinct() %>% 
  filter(state_region_name == "Shan")

townships %>% 
  filter(str_detect(township_name, "SAZ")) %>%  
  arrange(township_name)

# townships that do not exist in the vulnerability dataset, but exist in the locations data

townships %>% 
  anti_join(vulmmr %>% select(township_name2 = township_name, township_pcode) %>% distinct(),
             by = c("admin3_pcode" = "township_pcode"))

# checking the township names -- why are there two different admin codes and names for Laukkaing and 
# a whole bunch of other townships in Shan (North)? 

townships %>% 
  left_join(vulmmr %>% select(township_name2 = township_name, township_pcode) %>% distinct(),
             by = c("admin3_pcode" = "township_pcode")) %>% 
  mutate(match = township_name2 == township_name) %>% 
   filter(str_detect(township_name, "Laukkaing"))
```

### 5Ws

```{r message=FALSE, warning=FALSE}

fsc5w <- read_excel(
  "FSC 5W 2021 - GEOADMINS_final19_(included All IP Reports)_Jan to Sep 2021_IM Combined_Final.xlsx",
                  sheet = "FSC 5W Activites",
                  skip = 5) %>% 
  janitor::clean_names() %>% 
  select(month_of_implementation:hrp_version) %>% 
  rename_all(~str_replace_all(., "^number_of_", "")) %>%
  rename_all(~str_replace_all(., "^number_", "")) %>% 
  rename(admin4_pcode = admin3_pcode, 
         admin3_pcode = admin2_pcode) %>% 
  mutate(location = camp) %>% 
  mutate(location = ifelse(is.na(camp), industrial_zones, camp))%>% 
  mutate(location = ifelse(is.na(camp) & is.na(industrial_zones), village_ward_town, camp)) %>% 
  mutate(total_value_mmk = value_per_household * reached_households) %>% 
  mutate(industrial_zones = replace(industrial_zones, industrial_zones == "No", NA)) %>% 
  mutate(location = case_when(camp != "NA" ~ camp,
                              industrial_zones != "NA" ~ industrial_zones,
                              village_ward_town != "NA" ~ village_ward_town)) %>% 
  mutate(locations_fuzzy = str_replace_all(location, "[[:punct:]]", " ")) %>% 
  mutate(date = my(month_of_implementation)) %>% 
  mutate(state = as.character(fct_recode(state, 
                            "Kachin" = "kachin")))

fsc5w %>% count(unique_beneficiaries, beneficiaries_recurrency)
glimpse(fsc5w)
```


```{r}
fsc5w %>% 
  filter(industrial_zones != 'NA')

fsc5w %>% 
  filter(camp != "NA")

fsc5w %>% 
  filter(village_ward_town != "NA")

# only location where camp and industrial zone are both filled, 
# so just bear that in mind when you do the ifelse

fsc5w %>%  
  filter(camp != "NA" & industrial_zones != "NA")

glimpse(fsc5w)

fsc5w %>% count(state, township, sort = TRUE)

fsc5w %>% count(township, location, sort = TRUE)
```

### Location counts

```{r}


fsc5w %>% 
  filter(is.na(location)) %>% 
  count(implementing_partners, sort = TRUE)

sum(is.na(fsc5w$location))

fsc5w %>%  
  filter(location != "NA") %>% 
  group_by(location) %>% 
  summarise(partners = n_distinct(implementing_partners)) %>% 
  arrange(desc(partners)) %>% 
  count(partners, sort = TRUE)

fsc5w %>% 
  filter(location != "NA") %>% 
  group_by(implementing_partners) %>% 
  summarise(locations = n_distinct(location))  

fsc5w %>% 
  filter(location != "NA") %>% 
  group_by(implementing_partners) %>% 
  summarise(locations = n_distinct(location),
            townships = n_distinct(admin3_pcode),
            states = n_distinct(admin1_pcode)) %>%
  mutate(locations = ifelse(locations > 150, 150, locations)) %>% 
  ggplot(aes(x = locations)) +
  geom_histogram() +
  scale_y_continuous(breaks = seq(0, 10, by = 2)) +
  geom_vline(aes(xintercept = mean(locations)), size = 1, colour = "red")
           

fsc5w %>% 
  filter(location != "NA") %>% 
  group_by(implementing_partners) %>% 
  summarise(locations = n_distinct(location),
            townships = n_distinct(admin3_pcode),
            states = n_distinct(admin1_pcode)) %>%
  count(states, sort = TRUE) %>% 
  rename(partners = n) %>%  
  pander()

fsc5w %>% 
  filter(location != "NA") %>% 
  group_by(implementing_partners) %>% 
  summarise(locations = n_distinct(location),
            townships = n_distinct(admin3_pcode),
            states = n_distinct(admin1_pcode)) %>%
  count(townships, sort = TRUE) %>% 
  rename(partners = n) %>%  
  pivot_wider(names_from = townships, values_from = partners) %>% 
  mutate(townships = paste0("partners")) %>% 
  relocate(townships) %>% 
  pander()
 
```


### Skew in achievements

```{r}
fsc5w %>% 
  filter(unique_beneficiaries == "Yes") %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  arrange(desc(beneficiaries)) %>% 
  mutate(state = fct_lump(state, n = 8, w = beneficiaries)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(pc_of_total = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>%
  arrange(desc(beneficiaries)) %>% 
  pander(caption = "Beneficiaries reached by state/region")

fsc5w %>% count(beneficiaries_recurrency)
  

township_ben <- fsc5w %>% 
  filter(beneficiaries_recurrency != "Recurrent") %>% 
  group_by(township) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  arrange(desc(beneficiaries)) %>% 
  mutate(pc_of_total = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  head(10)

sum(township_ben$pc_of_total)

```


```{r}
ben %>% 
  group_by(location) %>% 
  summarise(partners = n_distinct(implementing_partners)) %>% 
  arrange(desc(partners))
```


```{r}
fsc5w %>%
  filter(township == "Hlaingtharya") %>% 
  fscben(activity)

```


```{r}

vulmmr %>% 
  filter(township_name == "Hlaingtharya") %>% 
  filter(str_detect(indicator, "pop")) %>% 
  select(indicator, value)

fsc5w %>% 
  group_by(activity) %>% 
  select(activity, township, admin3_pcode) %>% 
  distinct() %>% 
  left_join( vulmmr %>% 
    filter(indicator %in% c("total_pop_both_sexes", "pop_urban_both_sexes")) %>% 
    select(township_pcode, township_name, indicator, value) %>% 
    pivot_wider(values_from = value, names_from = indicator) %>% unnest(), 
    by = c("admin3_pcode" = "township_pcode")) %>% 
  group_by(activity) %>% 
  summarise(total_pop = sum(total_pop_both_sexes, na.rm = TRUE),
            pop_urban = sum(pop_urban_both_sexes, na.rm = TRUE)) %>% 
  mutate(pc_urban = pop_urban / total_pop) %>% 
  arrange(desc(pc_urban))
  
```



```{r}
fsc_partners <- fsc5w %>% select(implementing_partners) %>% distinct() %>% arrange(implementing_partners) %>% pull()
fsc_report <- fsc5w %>% select(reporting_organization) %>% distinct() %>% arrange(reporting_organization) %>% pull()
```

### Summaries by sex

```{r}
ben %>% 
  pivot_wider(names_from = disaggregation, values_from = beneficiaries) %>% 
  unnest() %>% 
  mutate(total_ben = rowSums(across(where(is.numeric))),
         child = child_male + child_female, 
         adult = adult_male + adult_female,
         elderly = elderly_male + elderly_female, 
         male = child_male + adult_male + elderly_male, 
         female = child_female + adult_female + elderly_female) %>% 
  group_by(activity) %>% 
  summarise_at(c("child", "adult", "elderly", "male", "female", "total_ben"), sum, na.rm = TRUE) %>% 
  mutate(child_pc = child / total_ben,
         adult_pc = adult / total_ben, 
         elderly_pc = elderly / total_ben,
         male_pc = male / total_ben,
         female_pc = female / total_ben) %>% 
  mutate_at(vars(child_pc:female_pc), ~ round(.*100, digits = 2)) %>% 
  select(activity, total_ben:female_pc) %>% 
  relocate(total_ben, .after = female_pc) %>%  
  pander()

fsc5w %>%  
  filter(beneficiaries_recurrency %in% c("First", "One-off")) %>% 
  mutate(child_total = child_male + child_female, 
         adult_total = adult_male + adult_female,
         elderly_total = elderly_male + elderly_female, 
         male_total = child_male + adult_male + elderly_male, 
         female_total = child_female + adult_female + elderly_female) %>% 
  group_by(activity) %>% 
  select(activity, reached_beneficiaries, child_total:female_total) %>% 
  summarise_at(vars(reached_beneficiaries:female_total), ~ sum(., na.rm = TRUE))  %>% 
  mutate(age_check = child_total + adult_total + elderly_total,
         sex_check = male_total + female_total)
  
  
fsc5w %>% 
  count(beneficiaries_recurrency)

ben %>%  
  mutate(child_total = ifelse(disaggregation %in% c("child_male", "child_female"), beneficiaries, 0),
         adult_total = ifelse(disaggregation %in% c("adult_male", "adult_female"), beneficiaries, 0),
         elderly_total = ifelse(disaggregation %in% c("elderly_male", "elderly_female"), beneficiaries, 0), 
         male_total = ifelse(disaggregation %in% c("child_male", "adult_male", "elderly_male"), beneficiaries, 0),
         female_total = ifelse(disaggregation %in% c("child_female", "adult_female", "elderly_female"), beneficiaries, 0)) %>% 
  group_by(activity) %>% 
  summarise_at(vars(beneficiaries:female_total), sum)
  
  
glimpse(fsc5w)        

```

```{r}
fsc5w %>%  
  filter(beneficiaries_recurrency %in% c("First", "One-off")) %>% 
  mutate(child_total = child_male + child_female, 
         adult_total = adult_male + adult_female,
         elderly_total = elderly_male + elderly_female, 
         male_total = child_male + adult_male + elderly_male, 
         female_total = child_female + adult_female + elderly_female) %>% 
  group_by(activity) %>% 
  select(activity, reached_beneficiaries, child_total:female_total) %>% 
  summarise_at(vars(reached_beneficiaries:female_total), ~ sum(., na.rm = TRUE))  %>% 
  mutate(age_check = child_total + adult_total + elderly_total,
         sex_check = male_total + female_total)
```


```{r}
ben  %>% count(activity)

ben %>%  
  filter(activity == "Provide technical training (agriculture, livestock breeding, livelihood)") %>% 
  group_by(disaggregation) %>% 
  summarise(beneficiaries = sum(beneficiaries))
```


### Regex stuff

```{r}
fsc5w %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  arrange(desc(beneficiaries))

unmatched <- fsc5w %>% 
  left_join(locations %>% select(location, location_type, location_code), by = "location") %>% 
  filter(is.na(location_type) & !is.na(location))

# don't run this -- the regex_left_join takes 10 years
# fsc5w %>% 
#   regex_left_join(locations %>% mutate(location2 = location) %>% select(location, location2), by = "location") %>% 
#   sum(is.na(location))

glimpse(unmatched)

locations 

unmatched$ID <- seq.int(nrow(unmatched))

unmatched %>% 
  select(-location_type, -location_code) %>% 
  stringdist_left_join(locations %>% select(locations_fuzzy, location_type, location_code, township_code = admin3_pcode), 
                       by = "locations_fuzzy", distance_col = "dist")  
  filter(admin3_pcode == township_code) %>% 
  group_by(ID) %>% 
  filter(row_number()== 1) 

locations %>% 
  filter(str_detect(locations_fuzzy, "Muyi"))

glimpse(matched)
class(matched)
  
```
### ben dataset

```{r}
fsc5w %>% 
  count(beneficiaries_recurrency)


# mutate the month_of_implementation into a date column 
# and then do some introductory plots 
# this should maybe take a few hours 

ben <- fsc5w %>% 
  filter(unique_beneficiaries == "Yes") %>%  
  select(date,
         implementing_partners, implementing_partner_type,
         state, township, village_ward_town, location, admin1_pcode, admin3_pcode,
         activity, activity_status, hrp_indicator, beneficiary_type = beneficiaries_type, 
         child_male, child_female, adult_male, adult_female, elderly_male, elderly_female) %>% 
  pivot_longer(cols = child_male:elderly_female, 
               names_to = "disaggregation", values_to = "beneficiaries", values_drop_na = TRUE) %>% 
  mutate(beneficiaries_type = as.character(
    fct_recode(beneficiary_type, 
               "Rakhine stateless" = "Non-displaced stateless people in Rakhine"))) 

act_order <- ben %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%
  mutate(activity = substr(activity, 0, 65)) %>% 
  arrange(desc(beneficiaries)) %>% pull(activity)

glimpse(fsc5w)

```

### Line plot

```{r}
ben %>% 
  group_by(activity) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>% 
   mutate(activity = substr(activity, 0, 55)) %>% 
  ggplot(aes(x = date, y = cum_ben, colour = activity)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  facet_wrap(~ activity, scales = "free_y") +
  theme(legend.position = "none") +
  labs(x = "", 
       y = "cumulative beneficiaries", 
       title = "Beneficiaries reached by activity, 2021") + 
  theme(plot.title = element_text(size = 12))
```

```{r}
ben %>% 
  filter(implementing_partners == "World Vision Myanmar") %>% 
  filter(activity == "Provide monthly food baskets through in-kind assistance to acutely food insecure population in rural areas") %>%
  group_by(date) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  arrange(desc(beneficiaries))

ben %>% 
  filter(implementing_partners == "World Vision Myanmar") %>% 
  group_by(activity) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>% 
  ggplot(aes(x = date, y = cum_ben, colour = activity)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  facet_wrap(~ activity, scales = "free_y") +
  theme(legend.position = "none") 

fben %>% 
  filter(implementing_partners == "World Vision Myanmar") %>% 
  filter(activity == "Provide monthly food baskets through in-kind assistance to acutely food insecure population in rural areas") %>%
  group_by(date) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(cum_ben = cumsum(beneficiaries))

```


```{r}

ben %>% 
  group_by(activity) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>%
  mutate(activity = substr(activity, 0, 45)) %>% 
  ggplot(aes(x = date, y = cum_ben, colour = activity)) +
  geom_line(size = 1) +
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  facet_wrap(~ activity, scales = "free_y") +
  theme(legend.position = "none") +
  labs(x = "", 
       y = "cumulative beneficiaries")

save_line_charts <- function(df, filename){
  
  temp_chart <- df %>%
    ggplot(aes(x = date, y = cum_ben, colour = activity)) +
    geom_line() +
    scale_y_continuous(labels = comma) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    facet_wrap(~ activity, scales = "free_y") +
    theme(legend.position = "none") +
  labs(x = "", 
       y = "cumulative beneficiaries")
  
  ggsave(filename = paste0(filename, ".pdf"), plot = temp_chart, width = 11, height = 8.5, units = "in", path = "./line_plots")
}

ben %>% 
  group_by(activity) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>%
  mutate(activity = substr(activity, 0, 45)) %>%
  nest(-implementing_partners) %$%
  walk2(data, implementing_partners, save_line_charts)
  
```

### Bar plot

```{r}
ben %>% 
  filter(implementing_partners == "WFP") %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(activity = substr(activity, 0, 55),
         activity = reorder(activity, beneficiaries)) %>% 
  ggplot(aes(y = activity, x = beneficiaries, fill = activity)) + 
  geom_col() +
  geom_text(aes(label = scales::comma(beneficiaries)), size = 3, hjust = -0.2) +
  scale_x_continuous(labels = comma, expand = expansion(c(0, 0.25))) +
  theme(legend.position = "none") +
  labs(x = "Beneficiaries",
       y = "")

save_bar_charts <- function(df, filename){
  
  temp_chart <- df %>%
   ggplot(aes(y = reorder(activity, beneficiaries), x = beneficiaries, fill = activity)) + 
   geom_col() +
   geom_text(aes(label = scales::comma(beneficiaries)), size = 3, hjust = -0.2) +
   scale_x_continuous(labels = comma, expand = expansion(c(0, 0.25))) +
   theme(legend.position = "none") +
   labs(x = "Beneficiaries",
        y = "")
  
  ggsave(filename = paste0(filename, ".pdf"), plot = temp_chart, width = 11, height = 8.5, units = "in", path = "./bar_plots")
}

ben %>% 
  group_by(implementing_partners, activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(activity = substr(activity, 0, 55)) %>% 
  nest(-implementing_partners)  %$% 
  walk2(data, implementing_partners, save_bar_charts)
```

# Partners and oversubscription

```{r}
glimpse(fsc5w)

fsc5w %>% 
  group_by(fsc_objectives) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries))

ben %>% 
  group_by(hrp_indicator) %>% 
  summarise(beneficiaries = sum(beneficiaries))

sum(fsc5w$reached_beneficiaries)

sum(ben$beneficiaries)

ben %>% 
  group_by(implementing_partners) %>% 
  summarise(states = n_distinct(admin1_pcode),
            townships = n_distinct(admin3_pcode), 
            beneficiaries = sum(beneficiaries)) %>% 
  arrange(desc(beneficiaries))

ben %>% 
  filter(implementing_partners == "MRCS") %>% 
  select(activity, township, state) %>% distinct()

# we shouldn't be working in Yangon anymore

ben %>% 
  group_by(township) %>% 
  summarise(partners = n_distinct(implementing_partners),
            beneficiaries = sum(beneficiaries)) %>% 
  mutate(pc_of_total = round(beneficiaries / sum(beneficiaries), digits = 3)) %>% 
  arrange(desc(beneficiaries))

ben %>% 
  filter(state == "Yangon") %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  arrange(desc(beneficiaries)) %>% pander()

ben %>% 
  filter(township == "Hlaingtharya") %>% 
  group_by(implementing_partners) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  arrange(desc(beneficiaries))

ben %>% 
  filter(implementing_partners == "Zigway") %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  arrange(desc(beneficiaries))

ben %>% 
  group_by(state) %>% 
  summarise(partners = n_distinct(implementing_partners),
            beneficiaries = sum(beneficiaries)) %>% 
  mutate(state = fct_reorder(state, -beneficiaries)) %>% 
  ggplot(aes(x = state, y = beneficiaries)) + 
  geom_col() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))

sr_order<- sr_pop %>%
  filter(indicator_type == "Total") %>% 
  select(state_region, population = value) %>% 
  left_join(ben %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = c("state_region" = "state")) %>% 
  mutate(population = population * 1000,
         beneficiaries = ifelse(!is.na(beneficiaries), beneficiaries, 0)) %>%
  mutate(state_region = fct_reorder(state_region, -beneficiaries)) %>%  
  select(state_region) %>% 
  pull()

sr_ord <- c("Yangon", "Rakhine","Kachin", "Ayeyarwady", "Kayin",  
  "Mon", "Mandalay", "Kayah", "Chin", "Sagaing", "Magway", 
  "Bago", "Nay Pyi Taw", "Shan", "Tanintharyi")

sr_pop %>%
  filter(indicator_type == "Total") %>% 
  select(state_region, population = value) %>% 
  left_join(ben %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = c("state_region" = "state")) %>% 
  mutate(population = population * 1000,
         beneficiaries = ifelse(!is.na(beneficiaries), beneficiaries, 0))  %>%  
  pivot_longer(cols = beneficiaries:population, names_to = "type", values_to = "value")  %>% 
  mutate(state_region = fct_reorder(state_region, sr_ord)) %>% 
  ggplot(aes(x = state_region, y = value, fill = type)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust = 0.5)) +
  theme(legend.title = element_blank())

```

```{r}

sr_ord <- c("Yangon", "Rakhine","Kachin", "Ayeyarwady", "Kayin",  
  "Mon", "Mandalay", "Kayah", "Chin", "Sagaing", "Magway", 
  "Bago", "Nay Pyi Taw", "Shan", "Tanintharyi")

vulmmr %>% 
  filter(indicator == "adjusted_approximate_vulnerable_population"|
         indicator  == "total_pop_both_sexes") %>% 
  select(state= state_region_name, indicator, value) %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  unnest() %>% 
  group_by(state) %>%  
  drop_na() %>%
  summarise(vulnerable_pop = sum(adjusted_approximate_vulnerable_population), 
            total_pop = sum(total_pop_both_sexes)) %>% 
  mutate(vulnerable_pc = vulnerable_pop / total_pop) %>% 
  left_join(ben %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = "state") %>% 
  mutate(beneficiaries = ifelse(!is.na(beneficiaries), beneficiaries, 0)) %>% 
  pivot_longer(cols = c(vulnerable_pop, beneficiaries), names_to = "type", values_to = "value") %>% 
  ggplot(aes(x = fct_relevel(state, sr_ord), y = value, fill = type)) + 
  geom_col(position = "dodge")+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust = 0.5)) +
  theme(legend.title = element_blank()) +
  labs(x = "",
       y = "", 
       title = "Food security beneficiaries and vulnerable population (MIMU)") +
  scale_y_continuous(labels = comma)

```

```{r}
vulmmr %>% 
  filter(indicator == "adjusted_approximate_vulnerable_population"|
         indicator  == "total_pop_both_sexes") %>% 
  select(state= state_region_name, indicator, value) %>% 
  pivot_wider(names_from = indicator, values_from = value) %>% 
  unnest() %>% 
  group_by(state) %>%  
  drop_na() %>%
  summarise(vulnerable_pop = sum(adjusted_approximate_vulnerable_population), 
            total_pop = sum(total_pop_both_sexes)) %>% 
  mutate(vulnerable_pc = vulnerable_pop / total_pop) %>% 
  left_join(ben %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = "state") %>% 
  mutate(beneficiaries = ifelse(!is.na(beneficiaries), beneficiaries, 0), 
         beneficiaries_pc = beneficiaries / vulnerable_pop * 100, 
         state = reorder(state, -beneficiaries_pc)) %>% 
  select(state, beneficiaries_pc) %>% 
  filter(beneficiaries_pc != 0) %>% 
  ggplot(aes(x = state, y = beneficiaries_pc)) +
  geom_col() +
  labs(x = "", 
       y = "% of vulnerable population reached")
```
### Beneficiaries and PIN

```{r}
old_pin <- read_excel("FSC PIN and Target _combine HRP and IERP 2021.xlsx") %>% 
  clean_names() %>% 
  rename(admin1_pcode = sr_pcode, 
         state = sr_name_eng, 
         admin3_pcode = tsp_pcode, 
         township = township_name_eng)
```


```{r}
fs_target <- read_excel("fs_targets_2021.xlsx") %>% 
  clean_names() %>% 
  rename(township = x1) %>% 
  rename_with(.cols = internally_displaced_persons_2:disabled_percent, 
              function(x){paste0("pin_", x)}) %>% 
  rename_with(.cols = internally_displaced_persons_12:total_16, 
              function(x){paste0("target_", x)}) %>% 
  rename_with(~gsub('[[:digit:]]+', "", .)) %>%
  rename(pin_idps = pin_internally_displaced_persons_,
         pin_idp_returnees_resettled_locally_integrated = pin_idp_returnees_resettled_locally_integrated_,
         pin_stateless_rakhine = pin_non_displaced_stateless_people_in_rakhine_,
         pin_other_vulnerable_crisis_affected_people = pin_other_vulnerable_crisis_affected_people_,
         pin_total = pin_total_,
         target_idp_returnees_resettled_locally_integrated = target_idp_returnees_resettled_locally_integrated_,
         target_stateless_rakhine = target_non_displaced_stateless_people_in_rakhine_,
         target_other_vulnerable_crisis_affected_people = target_other_vulnerable_crisis_affected_people_,
         target_total = target_total_) %>%
  left_join(townships %>% select(state = state_name, township = township_name)  %>% distinct(), by = "township")


fs_target %>% 
  right_join(ben %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = "state") %>% 
  mutate(beneficiaries = ifelse(!is.na(beneficiaries), beneficiaries, 0)) %>% 
  pivot_longer(cols = c(pin_total, beneficiaries), names_to = "type", values_to = "value") %>% 
  ggplot(aes(x = fct_relevel(state, sr_ord), y = value, fill = type)) + 
  geom_col(position = "dodge")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.4)) +
  theme(legend.title = element_blank()) +
  labs(x = "",
       y = "", 
       title = "Food security beneficiaries and people in need") +
  scale_y_continuous(breaks = seq(0, 1400000, by = 200000), labels = comma)
  

fs_target %>% 
  summarise(pin = sum(pin_total))
```


```{r}
vulmmr %>% 
  filter(str_detect(indicator, "urban")) %>% 
  select(indicator) %>% distinct() %>%  pull()

vulmmr %>% 
  filter(str_detect(indicator, "pop")) %>% 
  select(indicator) %>% distinct() %>%  pull()

glimpse(vulmmr)

vulmmr %>% 
  filter(indicator == "urban_population_percent_27" &
         township_name %in% c("Hlaingtharya", "Dala")) %>% 
  select(township_name, indicator, value)

vulmmr %>% 
  filter(indicator == "urban_population_percent_27") %>% 
  summarise(avg_urban = median(value, na.rm = TRUE))

```


### Map
```{r}
pcode3_shape <- st_read("./mmr_polbnda_adm3_mimu_250k/mmr_polbnda_adm3_mimu_250k.shp", quiet = TRUE) %>% 
  rename(state = ST, 
         admin1_pcode = ST_PCODE,
         township = TS,
         admin3_pcode = TS_PCODE)

pcode1_shape <- st_read("./mmr_polbnda_adm1_mimu_250k/mmr_polbnda_adm1_mimu_250k.shp", quiet = TRUE) %>% 
  rename(state = ST, 
         admin1_pcode = ST_PCODE)

pcode1_shape %>% select(state) %>% distinct()

fsc_pin %>% 
  left_join(pcode3_shape, by = "admin3_pcode") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(size = 0.1, aes(fill = total_pin)) +
  scale_fill_continuous(trans = "reverse") +
  geom_point() +
  theme_void()

fsc_pin
```

```{r}
st_read("./hard_to_reach_vt_may2019/hard_to_reach_vt_may2019.shp", quiet = TRUE) %>% 
  sf::sf_use_s2(FALSE) %>% 
  group_by(TS_PCODE) %>% 
  count(Category)
```



```{r}
fsc5w %>%  
  count(hrp_funding_if_project_under_fts, sort = TRUE)

fsc5w %>%  
  filter(beneficiaries_recurrency %in% c("First", "One-off")) %>% 
  group_by(hrp_funding_if_project_under_fts) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries))

fsc5w %>%  
  count(hrp_project_code, sort = TRUE)

glimpse(fsc5w)
```


```{r}
# maybe use this again at some point 

ben %>% 
  group_by(township) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  left_join(fsc_pin %>% select(township, pin = total_pin), by = "township") %>% 
  mutate(pc_of_total = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         pc_of_pin = round(pin / sum(pin, na.rm = TRUE) * 100, digits = 2),
         pc_reached = round(beneficiaries / pin * 100, digits = 2)) %>% 
  summarise(avg_reached = median(pc_reached, na.rm = TRUE))
```

```{r}

# for some reason, the mutate fct_reorder is not working
 
fsc5w %>% 
  mutate(beneficiaries_type = str_trim(beneficiaries_type)) %>% 
  mutate(beneficiaries_type = as.character(
    fct_recode(beneficiaries_type, 
               "Rakhine stateless" = "Non-displaced stateless people in Rakhine"))) %>%
  filter(beneficiaries_type != "NA") %>% 
  group_by(beneficiaries_type) %>% 
  mutate(avg_hhd = reached_beneficiaries / reached_households, na.rm = TRUE) %>% 
  ggplot(aes(x = fct_reorder(beneficiaries_type, avg_hhd), y = avg_hhd)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 20)) +
  labs(x = "Beneficiary type", 
       y = "Average household size")

```

### Agriculture

```{r}
fsc5w %>%  
  count(hrp_strategic_objective, sort = TRUE)

glimpse(fsc5w)

top5ag <- fsc5w %>% 
  filter(date %out% c("2021-01-01", "2021-02-01", "2021-03-01")) %>% 
  filter(str_detect(hrp_strategic_objective, "Strategic Objective 2")) %>% 
  filter(activity != "Cash for Work / Food for Assets activities") %>%
  group_by(implementing_partners) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  arrange(desc(beneficiaries)) %>% 
  head(5) %>% pull(implementing_partners)

fsc5w %>% 
  filter(date %out% c("2021-01-01", "2021-02-01", "2021-03-01")) %>% 
  filter(str_detect(hrp_strategic_objective, "Strategic Objective 2")) %>%
  filter(activity != "Cash for Work / Food for Assets activities") %>% 
  group_by(implementing_partners) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries),
            expenditures = sum(total_value_usd, na.rm = TRUE)) %>% 
  arrange(desc(beneficiaries)) %>% 
  head(5) %>% 
  mutate(country = paste0("Myanmar")) %>% 
  rename(organisation_name = implementing_partners, 
         total_people_reached = beneficiaries) %>% 
  relocate(country) %>%   
  write_csv("mmr_ag_top5.csv")

fsc5w %>%
  filter(date %out% c("2021-01-01", "2021-02-01", "2021-03-01")) %>% 
  filter(str_detect(hrp_strategic_objective, "Strategic Objective 2")) %>% 
  filter(implementing_partners %in% top5ag) %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries))
 
glimpse(fsc5w)


fsc5w %>% 
  filter(unique_beneficiaries == "Yes") %>% 
  group_by(reporting_organization) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  arrange(desc(beneficiaries))
```

### WFP pin calculations

```{r}
fsc_pin <- read_excel("PIN calculation Food Security Cluster_Township Breakdown.xlsx",
           sheet = "Food Sec PiN with IDPs", 
           skip = 2) %>% 
  clean_names() %>% 
  select(-c(x15, x16, x17, x18)) %>% 
  slice(1:346) %>% 
  fill(region) %>% 
  rename(state = region,
         idps = id_ps, 
         pop_minus_idps = population_minus_id_ps, 
         total_pin = vulnerable_food_insecure_people_id_ps) %>%  
  filter(township != "Total") %>%  
  mutate_at(vars(pop_minus_idps:moderately_severely), ~ as.numeric(.)) %>% 
  left_join(townships, by = c("township" = "township_name")) %>% 
  replace(is.na(.), 0)  %>% 
  select(-state) %>%  
  relocate(admin3_pcode) %>% relocate(state = state_name) %>% relocate(admin1_pcode) %>% 
  mutate(pc_vul = total_pin / total_pop,
         total_pin = round(total_pin, digits = 0))

fsc_pin %>% 
  mutate(has_idp = ifelse(idps > 0, "yes", "no"),
         idps = ifelse(idps == 0, NA_real_, idps)) %>%
  write_csv("fsc_pin2.csv")

```

```{r}

fsc_pin %>% select(admin1_pcode, state, admin3_pcode, township, total_pop, total_pin, pc_vul) %>% 
  left_join(ben %>% group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries)) %>% 
  ggplot(aes(x = total_pin, y = beneficiaries)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10()

fsc_pin %>% select(admin1_pcode, state, admin3_pcode, township, total_pop, total_pin, pc_vul) %>% 
  left_join(ben %>% group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries),
         pc_reached = round(beneficiaries / total_pin, digits = 2)) 
  
   
  
  mutate(gap = beneficiaries / total_pin,
         pc_ben = beneficiaries / sum(beneficiaries))  %>% 
  ggplot(aes(x = state, y = total_pin, text = paste0(township))) +
  geom_point(aes(size = beneficiaries, colour = pc_vul),  alpha = 0.5) +
  scale_colour_gradient(trans = "reverse") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle = 70,hjust = 0.5, vjust = 0.5),
        legend.position = "none") 


ggplotly(tsp_points, tootlip = c("x","y", "size"))

fsc_pin


```
# KIV code from the report

```{r}
# alternate facet plot using mmk 
fsc5w %>% 
  filter(!is.na(mmk_hhd_bin) & unique_beneficiaries == "Yes") %>%
  group_by(activity, mmk_hhd_bin) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  mutate(activity = substr(activity, 0, 70)) %>% 
  ggplot(aes(x = mmk_hhd_bin, y = beneficiaries, fill = activity)) +
  geom_col() +
  scale_y_continuous(labels = comma) +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 40, hjust = 0.5, vjust = 0.5),
        legend.position = "none") +
  facet_wrap(~ activity, scales = "free_y")
  
```

```{r}
# this is a great way to add a summary mean by column at th bottom of a table 
fsc5w %>% 
  filter(unique_beneficiaries == "Yes") %>% 
  group_by(delivery_modality, activity) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  pivot_wider(names_from = delivery_modality, values_from = beneficiaries) %>% 
  adorn_totals("col", na.rm = TRUE) %>% 
  mutate(across(`Cash`:`NA`, ~ round(.x / Total * 100, digits = 2))) %>% 
  rename(Beneficiaries = Total) %>% 
  select(-`NA`) %>% 
  ungroup %>% 
  summarise(activity = c(activity, 'Mean'), across(where(is.numeric), ~ c(., mean(., na.rm = TRUE)))) %>% 
  pander(caption = "Percentage breakdown of delivery modalities by activity")
```

```{r}
# we can ccome back to this later to check the super high values 
fsc5w %>% 
  filter(mmk_hhd_bin == "above_300k") %>% 
  group_by(implementing_partners, activity) %>%
  summarise(beneficiaries = sum(reached_beneficiaries)) %>% 
  arrange(desc(beneficiaries)) %>% 
  pander()

fsc5w %>% 
  filter(mmk_hhd_bin == "above_300k") 
  

```

```{r}
# this was to help the creation of the bins 
fsc5w %>%  
  filter(!is.na(value_per_household_usd) & unique_beneficiaries == "Yes") %>% 
  count(value_per_household_usd, wt = reached_beneficiaries, sort = TRUE) %>% 
  filter(n > 1000) %>% 
  arrange(value_per_household_usd)
```

```{r}
# location datasets are now read in as one single pipe chain 

# the geoadmins df was just an intermediate product
geoadmins <- read_excel("FSC 5W 2021 - GEOADMINS_final 19.xlsx",
           sheet = "GEOADMINS") %>% 
  clean_names() 

payams <- geoadmins %>%  
  select(state_name:payam_code) %>% 
  rename(admin1_pcode = state_code_12,
         township_name = county_name, 
         admin3_pcode = county_code,
         location = payam_name) %>%
  remove_empty() %>% 
  mutate(location_type = paste0("payam")) 
  

camps <- geoadmins %>% 
  select(county_name1:p_code_camp) %>% 
  rename(township_name = county_name1,
         admin3_pcode = state_code_23,
         location = camps, 
         camp_pcode = p_code_camp) %>% 
  remove_empty() %>% 
  mutate(location_type = paste0("camp")) %>% 
  left_join(townships %>% select(state_name, admin1_pcode, admin3_pcode), 
            by = c("admin3_pcode")) %>% 
  relocate(admin1_pcode) %>% 
  relocate(state_name)

# fuzzy joins has been done, now we just need to manually fill in the rest
# you're almost done here. 
industrial_zones <- geoadmins %>% 
  select(state_28:industrial_zones) %>% 
  rename(state_name = state_28, 
         admin1_pcode = admin1pcode_29,
         location = industrial_zones) %>%
  remove_empty() %>% 
  regex_left_join(townships %>% select(township_name, admin3_pcode),
                  by = c("location" = "township_name")) %>% 
  # replacing the NAs with 0s so the filter doesn't drop them 
  replace_na(list(township_name = 0, admin3_pcode = 0, admin1_pcode = 0)) %>%
  filter(admin3_pcode != "MMR013040") %>% # removing all the matches between Hlaingtharya and Hlaing
  filter(admin3_pcode != "MMR011006") %>% # removing all the matches between Yenangyaung and Ye
  mutate(location_type = paste0("industrial_zone"))

# writing the locations dataset
locations <- bind_rows(payams, camps, industrial_zones) %>%
  mutate(location_code = case_when(location_type == "camp" ~ camp_pcode,
                                   location_type == "payam" ~ payam_code,
                                   location_type == "industrial_zone" ~ NA_character_)) %>%
  mutate(locations_fuzzy = str_replace_all(location, "[[:punct:]]", ""))
```

```{r}
# low-value cash transfers
fsc5w %>% 
  filter(value_per_household == 15000 & unique_beneficiaries == "Yes") %>% 
  group_by(implementing_partners, activity) %>% 
  summarise(beneficiaries = sum(reached_beneficiaries))
```

```{r}

ben %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(beneficiaries = round(beneficiaries, digits = 0)) %>% 
  right_join(pcode1_shape, by = "state") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = beneficiaries), size = 0.1) +
  geom_sf_text(aes(label = beneficiaries), colour = "white", size = 2) +
  scale_fill_continuous(trans = "log10") + 
  scale_fill_gradient2(low= "lightskyblue", mid = "cornflowerblue", high = "navyblue") +
  theme_void()
```

```{r}
fsc %>% 
  group_by(reporting_organization, implementing_partners) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%  
  mutate(is_true = reporting_organization == implementing_partners) %>%  
  filter(is_true == TRUE)
```

```{r}
fsc %>% 
  filter(activity == "Provide monthly cash-based transfers to acutely food insecure population in rural areas") %>% 
  mutate(threshold = ifelse(value_per_household >= 190555, TRUE, FALSE)) %>% 
  fscben(threshold)
  
14592 / (1599901 + 14592)
```

```{r}
vulmmr %>% 
  select(state = state_region_name, adjusted_approximate_vulnerable_population, total_pop_both_sexes) %>% 
  group_by(state) %>%  
  drop_na() %>%
  summarise(vulnerable_pop = sum(adjusted_approximate_vulnerable_population), 
            total_pop = sum(total_pop_both_sexes)) %>% 
  mutate(vulnerable_pc = vulnerable_pop / total_pop) %>% 
  left_join(ben %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = "state") %>% 
  mutate(beneficiaries = ifelse(!is.na(beneficiaries), beneficiaries, 0)) %>% 
  pivot_longer(cols = c(vulnerable_pop, beneficiaries), names_to = "type", values_to = "value") %>% 
  ggplot(aes(x = fct_relevel(state, sr_ord), y = value, fill = type)) + 
  geom_col(position = "dodge")+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust = 0.5)) +
  theme(legend.title = element_blank()) +
  labs(x = "",
       y = "", 
       title = "Food security beneficiaries (5Ws) and vulnerable population (MIMU)") +
  scale_y_continuous(labels = comma)
```

```{r}
# fct_reorder not working 
act_ord <- c('Provide monthly food baskets through in-kind assistance to acutely food',
'Provide monthly cash-based transfers to acutely food insecure population',
'Provide crops & vegetables kits (in-kind / CBT)',                        
'Cash for Work / Food for Assets activities',                             
'Provide support for Income Generating Activities',                      
'Provide technical training (agriculture, livestock breeding, livelihood)',
'Provide fishery kits (in-kind / CBT)',                                    
'Provide livestock kits (in-kind / CBT)')

ben %>% 
  fscben(activity) %>% 
  mutate(activity = substr(activity, 0, 72),
         activity = reorder(activity, -beneficiaries)) %>%
  pull(activity) 

```

```{r}
# checking recurrent beneficiaries 
# do you really need this? maybe you can just get rid of this
fsc %>% 
  group_by(beneficiaries_recurrency, date) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(pc_of_total = beneficiaries / sum(beneficiaries)) %>% 
  ggplot(aes(x = date, y = beneficiaries)) +
  geom_line() +
  facet_wrap(~ beneficiaries_recurrency, scales = "free_y")

fsc %>%  
  group_by(beneficiaries_recurrency, frequency) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  filter(frequency == "Other")

fsc %>% 
  count(frequency)

```

```{r}
fsc %>%  
  filter(frequency == "Monthly") %>% 
  group_by(implementing_partners, activity, township, location) %>%
  summarise(recurrences = n_distinct(date)) %>% 
  arrange(desc(recurrences)) %>% 
  ungroup() %>% 
  count(recurrences) %>% 
  mutate(recurrences = recode(recurrences, 
                              `1` = "one", `2` = "two", `3` = "three", `4` = "four", `5` = "five", `6` = "six", `7` = "seven", `8` = "eight", 
                              `9` = "nine")) %>% 
  pivot_wider(names_from = recurrences, values_from = n)
  
  
```

```{r}
fsc %>%  
  filter(frequency == "Monthly") %>% 
  group_by(implementing_partners, activity, township, location) %>%
  summarise(recurrences = n_distinct(date),
            locations = n_distinct(location)) %>% 
  ungroup() %>% 
  filter(recurrences == 1)
```

```{r}
# the monthly category seems fairly clean, with only 152 locations and their associated activities needing to be recoded as one-off

fsc %>%
  filter(frequency == 'Monthly') %>%
  group_by(activity, township, location, date) %>%
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>% 
  count(activity,township, location, name = "monthly_recurrences", sort = TRUE) %>% 
  count(monthly_recurrences, name = "locations") %>% 
  pander(caption = "Locations by number of monthly recurrences")

```

```{r}
fsc %>%  
  filter(frequency == "Monthly") %>% 
  group_by(implementing_partners, activity, township, location) %>%
  summarise(recurrences = n_distinct(date),
            locations = n_distinct(location)) %>% 
  ungroup() %>% 
  filter(recurrences > 5) %>% 
  group_by(activity, implementing_partners) %>% 
  summarise(locations = sum(locations), .groups = "drop") %>% 
  arrange(desc(locations)) %>% 
  arrange(activity) %>% 
  distinct() %>% 
  kable(caption = "Recurrent activities implemented for 6 months or more; priorities for programme monitoring") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r}
# this is the version compared to the 2022 PIN
pin %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries))) %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            total_pin = sum(total_pin)) %>% 
  pivot_longer(-state, names_to = "type", values_to = "value") %>% 
  ggplot(aes(x = fct_relevel(state, sr_ord), y = value, fill = type)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(vjust = 0.4, angle = 70)) +
  theme(legend.title = element_blank()) +
  labs(x = "",
       y = "", 
       title = "Food security beneficiaries and people in need") +
   scale_y_continuous(breaks = seq(0, 2000000, by = 200000), labels = comma)
```


```{r}
# this is the version that compares to the 2022 PIN
pin %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            PIN = sum(total_pin)) %>% 
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         `%_of_PIN` = round(PIN / sum(PIN) * 100, digits = 2),
         `%_PIN_reached` = ifelse(is.infinite(beneficiaries / PIN * 100), NA_real_, beneficiaries / PIN * 100),
         `%_PIN_reached` = round(`%_PIN_reached`, digits = 2))  %>% 
  relocate(`%_of_ben`, .after = beneficiaries) %>% 
  arrange(desc(`%_PIN_reached`)) %>% 
  kable(caption = "Beneficiaries reached and PIN by state/region", format.args = list(big.mark = ",")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
 
```

```{r}
# old version which compares to 2022 PIN 
ben %>% 
  group_by(township) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  left_join(pin %>% select(township, state, pin = pin_2021), by = "township") %>% 
  mutate(pc_of_total = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         pc_of_pin = round(pin / sum(pin, na.rm = TRUE) * 100, digits = 2),
         pc_reached = round(beneficiaries / pin * 100, digits = 2)) %>% 
  relocate(pc_of_total, .after = beneficiaries) %>% 
  relocate(state, .after = township) %>% 
  arrange(desc(pc_of_total)) %>% 
  head(10) %>% 
  pander(caption = "Top 10 townships by beneficiaries reached")
```

```{r}
ben %>% 
  group_by(township) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  left_join(pin %>% select(township, state, target = target_2021), by = "township") %>% 
  filter(target > 0) %>% 
  arrange(beneficiaries)

fsc %>% 
  filter(unique_beneficiaries == "Yes") %>% 
  group_by(admin3_pcode) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  left_join(pin %>%  select(admin3_pcode, township, state, target_2021), by = "admin3_pcode") %>% 
  filter(target_2021 > 0) %>% 
  arrange(beneficiaries)
```

```{r}
# for the percentage of beneficiaries form townships with targets
ben %>% 
  group_by(admin3_pcode, township, state) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  left_join(pin %>% select(admin3_pcode, target = target_2021), by = "admin3_pcode") %>% 
  mutate(in_hrp = ifelse(target > 0, "yes", "no"),
         in_hrp = ifelse(is.na(in_hrp), "no", in_hrp)) %>% 
  fscben(in_hrp) %>% 
  adorn_totals("row")

1847337 / 2088142
```

```{r map-partners-pin, fig.height=11}

ben %>% 
  group_by(state) %>% 
  summarise(partners = n_distinct(implementing_partners)) %>% 
  right_join(pcode1_shape, by = "state") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = partners), size = 0.1) +
  geom_sf_text(aes(label = partners), size = 3) +
  scale_fill_gradient(trans = "reverse") +
  theme_void() + 
  theme(legend.text = element_text(size = 4),
        legend.title = element_text(size = 4),
        legend.key.size = unit(0.5, 'cm')) +
  labs(title = "Map of number of partners by state/region") +

pin %>% 
  group_by(state) %>% 
  summarise(PIN = sum(total_pin)) %>% 
  mutate(PIN = round(PIN, digits = 0), 
         PIN = recode(PIN, 
                      '0' = NA_real_)) %>%
  right_join(pcode1_shape, by = "state") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = PIN), size = 0.1) +
  geom_sf_text_repel(aes(label = scales::comma(PIN)), size = 2.5) +
  scale_fill_gradient(trans = "reverse") +
  theme_void() +
  theme(legend.text = element_text(size = 4),
        legend.title = element_text(size = 4),
        legend.key.size = unit(0.5, 'cm')) +
  labs(title = "Map of PIN by state/region")

```

```{r}
# old table, not necessary
fsc %>% 
  filter(!is.na(beneficiary_type) & unique_beneficiaries == "Yes") %>% 
  group_by(admin3_pcode, beneficiary_type) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>%
  pivot_wider(names_from = beneficiary_type, values_from = beneficiaries) %>% 
  mutate(total_beneficiaries = rowSums(across(where(is.numeric)), na.rm = TRUE)) %>% 
  left_join(pin %>% 
              select(admin3_pcode, hrp_target_idps_2021, hrp_target_returnees_2021, hrp_target_stateless_rakhine_2021, 
                     hrp_target_other_vulnerable_2021, hrp_target_total), by = "admin3_pcode") %>% 
  replace(is.na(.), 0) %>%  
  mutate(total_target = hrp_target_idps_2021 + hrp_target_stateless_rakhine_2021 + 
           hrp_target_stateless_rakhine_2021 + hrp_target_other) %>% 
  mutate(idp_pc = `Internally Displaced` / hrp_target_idps_2021,
         returnees_pc = Returnees / hrp_target_returnees_2021,
         rakhine_stateless_pc = `Rakhine stateless` / hrp_target_stateless_rakhine_2021,
         host_pc = `Host/local Community` / hrp_target_other,
         total_pc = total_beneficiaries / total_target) %>%  
  select(state, host_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc) %>%
  mutate_at(vars(host_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc), ~ replace(., is.nan(.), NA)) %>%
  mutate_at(vars(host_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc), ~ replace(., is.infinite(.), NA)) %>%
  mutate_at(vars(host_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc), ~ round(. * 100, digits = 2)) %>%
  filter(!is.na(host_pc) | !is.na(idp_pc) | !is.na(returnees_pc) | !is.na(rakhine_stateless_pc)) %>% 
  pander(caption = "Percentage of 2021 HRP target reached by beneficiary type")

```

```{r}
# just looking around at household sizes 

hhd_labs_act <- fsc %>%  
  group_by(activity) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE),
            households = sum(households, na.rm = TRUE)) %>% 
  mutate(avg_hhd_size = round(beneficiaries / households, digits = 2)) 

fsc %>% 
  group_by(activity) %>% 
  mutate(avg_hhd_size = beneficiaries / households, na.rm = TRUE) %>% 
  ggplot(aes(x = fct_reorder(activity, avg_hhd_size), y = avg_hhd_size)) + 
  geom_boxplot() +
  geom_text(data = hhd_labs_act, aes(label = avg_hhd_size), size = 2.5) +
  scale_y_continuous(breaks = seq(0, 14, 2), limits = c(0,14)) +
  labs(x = "", 
       y = "Average household size",
       title = "Average household size by activity")

fsc %>% filter(usd_hhd_bin == ">=$10_<$20" & 
                 activity == "Provide monthly cash-based transfers" &
                 unique_beneficiaries == "Yes") %>% 
  mutate(avg_hhd_size = beneficiaries / households, na.rm = TRUE) %>% 
  mutate(hhd_size_bin = case_when(avg_hhd_size < 1 ~ ">1",
                                  avg_hhd_size >=1 & avg_hhd_size <2 ~ ">=1_<2",
                                  avg_hhd_size >=2 & avg_hhd_size <3 ~ ">=2_<3",
                                  avg_hhd_size >=3 & avg_hhd_size <4 ~ ">=3_<4",
                                  avg_hhd_size >=4 & avg_hhd_size <5 ~ ">=4_<5",
                                  avg_hhd_size >=5 & avg_hhd_size <6 ~ ">=5_<6",
                                  avg_hhd_size >=6 ~ ">=6")) %>% 
  group_by(hhd_size_bin) %>% 
  summarise(beneficiaries = sum(beneficiaries)) 
  
  ggplot(aes(x = fct_reorder(activity, avg_hhd_size), y = avg_hhd_size)) + 
  geom_boxplot() +
  geom_text(data = hhd_labs_act, aes(label = avg_hhd_size), size = 2.5) +
  scale_y_continuous(breaks = seq(0, 14, 2), limits = c(0,14)) +
  theme(axis.text.x = element_text(angle = 70)) 
  labs(x = "", 
       y = "Average household size",
       title = "Average household size by activity")

fsc %>% count(usd_hhd_bin)
```

```{r}


round(sum(target_ben_2021$beneficiaries) / sum(target_ben_2021$target_2021) * 100, digits = 2)

%>% format(big.mark = ",")

%>% arrange(desc(pc_reached)) %>% 
  mutate(pc_bin = case_when(pc_reached <= 80 ~ "under80",
                            pc_reached > 80 & pc_reached <= 100 ~ "80to100",
                            pc_reached > 100 & pc_reached <= 120 ~ "100to120",
                            pc_reached > 120 ~ "more120")) %>% 
  group_by(pc_bin) %>% 
  summarise(count = n())
  
```

```{r}
fsc %>% 
  filter(township %in% c("Bhamo", "Mogaung", "Momauk", "Myitkyina")) %>% 
  group_by(township) %>% 
  summarise(partners = n_distinct(implementing_partners))

fsc %>% 
  filter(township %in% c("Bhamo", "Mogaung", "Momauk", "Myitkyina")) %>%
  filter(unique_beneficiaries == "Yes") %>% 
  group_by(implementing_partners, township, hrp_indicator, activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  pivot_wider(names_from = township, values_from = beneficiaries) %>% 
  write_csv("fsc_partners_Bhamo_Mogaung_Momauk_Myitkyina_2021JantoSep.csv")
  
```

```{r}
fsc %>% 
  filter(!is.na(usd_hhd_bin) & unique_beneficiaries == "Yes" & !is.na(cash_delivery_mechanism) ) %>% 
  filter(delivery_modality %in% c("Cash", "Hybrid (In-kind & Cash)", "Voucher")) %>% 
  mutate(households = round(households)) %>% 
  group_by(cash_delivery_mechanism) %>% 
  summarise(households = sum(households),
            total_value_usd = sum(total_value_usd)) %>% 
  mutate(avg = total_value_usd / households) %>%  arrange(desc(avg))
```

### Talk with Aung to see if it's useful and if we're doing anything with it 

```{r}

fsc %>% 
  mutate(months_of_food_ration_distributed = recode(months_of_food_ration_distributed,
                "1" = "1_month",
                "one month" = "1_month",
                "1 month" = "1_month",
                "2" = "2_months",
                "2 months" = "2_months",
                "3" = "3_months",
                "3 months" = "3_months",
                "June, July,August" = "3_months",
                "March to May" = "3_months",
                "4 months" = "4_months",
                "5" = "5_months",
                "5 th times" = "5_months",
                "6" = "6_months",
                "7" = "7_months")) %>% 
  filter(str_detect(months_of_food_ration_distributed, "_month")) %>% 
  group_by(months_of_food_ration_distributed, usd_hhd_bin) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%  
  pivot_wider(names_from = usd_hhd_bin, values_from = beneficiaries)
  
```

Additionally, the variations in cash transfer values within the same organisation should also be explored in more depth, below is a table breaking down, by percentage of beneficiary frequencies, the various values per household employed by partners implementing monthly cash transfers:

```{r}
fsc %>% 
  filter(activity == "Provide monthly cash-based transfers") %>% 
  filter(!is.na(usd_hhd_bin)) %>% 
  group_by(usd_hhd_bin, implementing_partners) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  pivot_wider(names_from = usd_hhd_bin, values_from = beneficiaries) %>% 
  adorn_percentages("row") %>%
  mutate(across(-implementing_partners, ~ round(. * 100, digits = 2))) %>% 
  kable(caption = "Variation in monthly cash transfer values within partners; figures show percentage of beneficiary frequencies",
        format.args = list(big.mark = ","), align = "c") %>% 
  kable_classic_2(lightable_options = c("striped"))
  

```


### 4.3 Beneficiaries by activity frequency

The categories "First" and "Monthly" in the frequency column do not seem to be filled as intended, as can be seen from the plot below:

<br>

```{r line-plot-first-monthly}

fsc %>% 
  filter(frequency == "First" | frequency == "Monthly") %>% 
  filter(activity == "Provide monthly food baskets") %>% 
  group_by(date, frequency) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%
  ggplot(aes(x = date, y = beneficiaries, colour = frequency)) + 
  geom_line(size = 1) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  labs(x = "",
       y = "Beneficiaries",
       title = "Beneficiaries reached by frequency -- comparison between 'First' and 'Monthly'") +
  theme(plot.title = element_text(size = 12)) 

fsc %>%  filter(frequency == "First") %>% 
  sum_ben(activity)
```

The assumption for these categories is that the first instance of a beneficiary receiving support (as part of a continuing monthly support package) would fall under the category "First" and every subsequent time they received support, it would be under "Monthly". 

But we can see that this is not the case -- monthly beneficiaries predated the use of the "First" category by at least four months; furthermore, the spike in first-time beneficiaries in May 2021 was not accompanied by any increase in monthly beneficiaries in the subsequent months -- in fact, there was a decline in monthly beneficiaries. Complicating all this is that we are not sure which of the beneficiaries track beneficiaries in a comprehensive manner i.e. with a beneficiary database and beneficiary ID cards. All this indicates that -- after confirming this with partners -- we should abandon the "First" category and recode these entries as "One-off".

```{r}
fsc %>% 
  filter(!is.na(delivery_modality)) %>% 
  group_by(delivery_modality, hrp_indicator) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>%
  mutate(delivery_modality = recode(delivery_modality, 
                                    "Hybrid (In-kind & Cash)" = "Hybrid",
                                    "Service delivery/support" = "Services/support")) %>%  
  mutate(cash = case_when(delivery_modality == "Cash" ~ "cash",
                          delivery_modality == "Hybrid" ~ "cash",
                          delivery_modality == "In-kind" ~ "in_kind", 
                          delivery_modality == "Services/support" ~ "in_kind",
                          delivery_modality == "Voucher" ~ "cash")) %>% 
  group_by(cash, hrp_indicator) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%  
  pivot_wider(names_from = cash, values_from = beneficiaries) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>%  
  pander()
```

### gfsc report


```{r}
fsc %>% 
  filter(!is.na(total_value_usd)) %>% 
  group_by(activity) %>% 
  summarise(total_usd = sum(total_value_usd), 
            beneficiaries = sum(beneficiaries)) %>% 
  mutate(per_ben = round(total_usd / beneficiaries, digits = 2)) %>% 
  write_csv("gfsc_report_usd.csv")


```





```{r}
fsc %>%  
  filter(delivery_modality %in% c("In-kind", "Service delivery/support")) %>%
  mutate(unit = recode(unit_for_in_kind_assistance,
                       "Metric Ton (Collective Sale Volume)" = "Metric Ton",
                       "Metric Ton (Farmer could sell GAP products to collective market)" = "Metric Ton",
                       "Metric Ton (Sale Volume)" = "Metric Ton",
                       "Metric Ton" = "Metric Ton",
                       "basket, kg" = "kg",
                       "set, kg" = "kg",
                       "KG" = "kg",
                       "kg" = "kg")) %>% 
  mutate(quantity_metric = case_when(unit == "Metric Ton" ~ quantity_for_in_kind_assistance,
                                     unit == "kg" ~ quantity_for_in_kind_assistance / 1000)) %>% 
  mutate(unit = recode(unit, "kg" = "Metric Ton")) %>%
  filter(unit == "Metric Ton") %>% 
  group_by(activity) %>% 
  summarise(metric_tons = sum(quantity_metric, na.rm = TRUE),
            beneficiaries = sum(beneficiaries)) %>% 
  pander()
  
  
fsc %>%  
  filter(delivery_modality %in% c("In-kind", "Service delivery/support")) %>%
  sum_ben(unit_for_in_kind_assistance)
  
  count(unit_for_in_kind_assistance, sort = TRUE)

fsc %>%  count(delivery_modality)

fsc %>% 
  filter(delivery_modality %in% c("In-kind", "Service delivery/support")) %>%
  sum_ben()


55334.6952 *1000 /4386538

1609295 / 6457624	
```

### follow up with partners 

```{r}
# for follow up with partners
fsc %>%  
  filter(value_per_household_usd == 10.5 & activity == "Provide monthly cash-based transfers") %>% 
  group_by(date, implementing_partners) %>%  
  summarise(beneficiaries = sum(beneficiaries)) %>%  
  ggplot(aes(x = date, y = beneficiaries, fill = implementing_partners)) +
  geom_col() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  facet_wrap(~ implementing_partners, scales = "free_y") +
  theme(legend.position = "none") +
  labs(x = "",
       y = "Number of beneficiary frequencies")

```

```{r}
# reminder: check up on Karuna Mission Social Solidarity -- did they up their package values? or were the previous entries just an incomplete amount
# why does karuna have so many differing amounts?

fsc %>% filter(value_per_household_usd == 10.5 & unique_beneficiaries == "Yes") %>% 
  sum_ben(implementing_partners)

fsc %>% 
  filter(str_detect(implementing_partners, "Karuna") & activity == "Provide monthly cash-based transfers") %>% 
  group_by(usd_hhd_bin, date) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%  pivot_wider(names_from = usd_hhd_bin, values_from = beneficiaries) %>% 
  arrange(date)
```

<br><br>

### 4.5 Calculation of unique beneficiaries

Perhaps one last thing to consider is the standardisation of calculations for unique beneficiaries -- currently, this classification is handled manually, where partner data, 

```{r}
fsc %>% 
  filter(!is.na(location)) %>% 
  group_by(township, location) %>% 
  slice(which.max(beneficiaries)) %>%
  group_by(state) %>% 
  summarise(ben_by_location = sum(beneficiaries)) %>% 
  left_join(fsc %>% 
              filter(unique_beneficiaries == "Yes") %>% 
              group_by(state) %>% 
              summarise(ben_col_unique = sum(beneficiaries))) %>% 
  mutate(difference = round((ben_by_location - ben_col_unique) / ben_col_unique * 100, digits = 2))

fsc %>% count(implementing_partners)

fsc %>%  count(reporting_organization)
```

```{r}
fsc %>% 
  filter(!is.na(location)) %>% 
  group_by(activity, township, location) %>% 
  slice(which.max(beneficiaries)) %>% 
  ungroup() %>% 
  group_by(activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  left_join(fsc %>% 
              filter(beneficiaries_recurrency %in% c("First", "One-off")) %>% 
              group_by(activity) %>% 
              summarise(u_ben = sum(beneficiaries)))

```


### Kayah Kayin

```{r}
fsc %>%  
  filter(state %in% c("Kayah", "Kayin") & unique_beneficiaries == "Yes") %>% 
  filter(!is.na(location)) %>% 
  group_by(state, township) %>% 
  summarise(beneficiaries = sum(beneficiaries),
            locations = n_distinct(location))

fsc %>%  
  filter(state %in% c("Kayah", "Kayin") & unique_beneficiaries == "Yes") %>% 
  group_by(implementing_partners) %>% 
  summarise(beneficiaries = sum(beneficiaries),
            locations = n_distinct(location))
```

```{r}
fsc %>%  
  group_by(admin3_pcode, hrp_ierp) %>% 
  summarise(hrp_ip = n_distinct(implementing_partners[hrp_ierp == "hrp"]),
            ierp_ip = n_distinct(implementing_partners[hrp_ierp == "ierp"]),
            non_hrp_ip = n_distinct(implementing_partners[hrp_ierp == "non_hrp"])) %>%  write_csv("check_hrp_ierp_ip.csv")

fsc %>% 
  group_by(admin3_pcode) %>%  
  summarise(n_distinct(implementing_partners)) %>% 
  write_csv("check_ip_tsp.csv")

fsc %>% 


```

This section pertains to the `r filter(pin, target_2021 > 0) %>% nrow()` townships which had HRP or IERP targets in 2021. For 

Overall, `r round(sum(target_ben_2021$beneficiaries) / sum(target_ben_2021$target_2021) * 100, digits = 2)`% of the targetted population was reached.

### 1.4 Township achievements related to the HRP and IERP -- move this to the top

This section pertains to the `r filter(pin, target_2021 > 0) %>% nrow()` townships which had HRP or IERP targets in 2021. For 

Overall, `r round(sum(target_ben_2021$beneficiaries) / sum(target_ben_2021$target_2021) * 100, digits = 2)`% of the targetted population was reached. From the histogram below, we can see that overreach and under-reaching were very common -- townships are commonly clustered at both extremes of the scale, around 0% of their target reached and also at 200% or more of the target reached. It is also important to note that two townships -- Hpapun in Kayin and Kyethi in Shan (South) have been targetted since the initial 2021 HRP, yet have not been reached by any FSC activities; additionally, Dagon Myothit (North), Insein and Chanayethazan in Yangon were targetted in the IERP and also have not been reached by any FSC activities. 

Of the `r nrow(filter(ts_target_reached, beneficiaries != 0))` townships with HRP/IERP targets that were reached in 2021; `r nrow(filter(ts_target_reached, pc_reached > 120))` townships reached more than 120% of their target, `r nrow(filter(ts_target_reached, pc_reached > 100 & pc_reached <= 120))` reached between 100% and 119% of their target; `r nrow(filter(ts_target_reached, pc_reached > 80 & pc_reached <= 100))` townships reached between 80% and 100% of their target; and `r nrow(filter(ts_target_reached, pc_reached <= 80 & pc_reached != 0))` townships reached less than 80% of their target.


```{r datasets-for-hrp-ierp-barplot}
act_ord <- fsc %>% 
  filter(hrp_ierp != "non_hrp" & unique_beneficiaries == "Yes") %>%
  sum_ben(activity) %>% pull(activity)

act_ben <- fsc %>% 
  filter(hrp_ierp != "non_hrp" & unique_beneficiaries == "Yes") %>%
  sum_ben2(activity, hrp_ierp) %>% pull(beneficiaries)

hrp_act <- fsc %>%  
  filter(hrp_ierp != "non_hrp" & unique_beneficiaries == "Yes") %>%
  sum_ben(activity) %>% 
  mutate(pc_of_ben = round(beneficiaries / sum(beneficiaries) * 100, digits = 2))
```

Mandalay has the largest difference between targets and beneficiaries reached. There were five states (Ayeyarwady, Mon, Sagaing, Magway and Tanintharyi) where beneficiaries were reached but were not included as part of the 2021 target or PIN. However, the beneficiaries reached in these areas represent less than 5% of all beneficiaries reached. Additionally, targets have been exceeded in all states except Mandalay, with Kayin having reached 994% of its target of 6,855 persons.

```{r}
ben %>% 
  group_by(admin3_pcode, township, state) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>% 
  left_join(pin %>% select(admin3_pcode, target = target_2021), by = "admin3_pcode") %>%
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         `%_of_target` = ifelse(is.infinite(target / sum(target, na.rm = TRUE) * 100), NA_real_, target / sum(target, na.rm = TRUE) * 100),
         `%_of_target` = round(`%_of_target`, digits = 2),
         `%reached` = ifelse(is.infinite(beneficiaries / target * 100), NA_real_, beneficiaries / target * 100),
         `%reached` = round(`%reached`, digits = 2), 
         target = round(target)) %>% 
  select(-admin3_pcode) %>% 
  relocate(`%_of_ben`, .after = beneficiaries) %>% 
  relocate(state, .after = township) %>% 
  arrange(desc(beneficiaries)) %>% 
  head(10) %>% 
  kable(caption = "Top 10 townships by beneficiaries reached (desc) in 2021", format.args = list(big.mark = ",")) %>% 
  kable_classic_2(lightable_options = c("striped")) 
# pander(caption = "Top 10 townships by beneficiaries reached (desc) in 2021")

fsc %>% 
  filter(unique_beneficiaries == "Yes") %>% 
  group_by(township) %>% 
  summarise(HRP_ben = sum(beneficiaries[hrp_ierp == "hrp"]),
            IERP_ben = sum(beneficiaries[hrp_ierp == "ierp"]),
            non_HRP_ben = sum(beneficiaries[hrp_ierp == "non_hrp"]), 
            total_ben = sum(beneficiaries)) %>% 
  mutate(`%_of_total_ben` = round(total_ben / sum(total_ben) * 100, digits = 2))%>% 
  arrange(desc(total_ben)) %>% 
  head(10) %>% 
  kbl(caption = "Top 10 townships by beneficiaries reached (desc)", format.args = list(big.mark = ",")) %>% 
  kable_classic_2(lightable_options = c("striped")) 
```

```{r}
# change formulas to look at % of target and show PIN, target and achievement in the table 
pin %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            target = round(sum(target_2021), digits = 0), 
            PIN = round(sum(pin_2021), digits = 0)) %>%
  filter(beneficiaries > 0 | PIN > 0) %>% 
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         `%_target_reached` = ifelse(is.infinite(beneficiaries / target * 100), NA_real_, beneficiaries / target * 100),
         `%_target_reached` = round(`%_target_reached`, digits = 2),
         `%_of_target` = round(target / sum(target) * 100, digits = 2))  %>% 
  relocate(`%_of_ben`, .after = beneficiaries) %>% 
  relocate(`%_target_reached`, .after = target) %>% 
  relocate(`%_of_target`, .after = target) %>% 
  arrange(desc(beneficiaries)) %>% 
  kbl(caption = "Beneficiaries reached (desc.), 2021 PIN and targets by state/region", format.args = list(big.mark = ",")) %>% 
  kable_classic_2(lightable_options = c("striped")) 
# pander(caption = "Beneficiaries reached (desc.), 2021 PIN and targets by state/region")

```

```{r}
pcode1_shape <- st_read("./mmr_polbnda2_adm1_mimu_250k/mmr_polbnda2_adm1_mimu_250k.shp", quiet = TRUE) %>% 
  rename(state = ST, 
         admin1_pcode = ST_PCODE)
```

```{r}

hrp_act_ord <- fsc %>% 
  filter(hrp_ierp != "non_hrp" & unique_beneficiaries == "Yes") %>% 
  group_by(hrp_ierp, activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  ungroup() %>% 
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  group_by(activity) %>%
  mutate(ben_max = max(beneficiaries)) %>% 
  arrange(desc(ben_max)) 

fsc %>% 
  filter(hrp_ierp != "non_hrp" & unique_beneficiaries == "Yes") %>% 
  group_by(hrp_ierp, activity) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(hrp_ierp = recode(hrp_ierp, "hrp" = "HRP", "ierp" = "IERP")) %>% 
  rename(hrp_version = hrp_ierp) %>% 
  ungroup() %>% 
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  group_by(activity) %>% 
  mutate(ben_max = max(beneficiaries)) %>% 
  arrange(desc(ben_max)) %>% select(-ben_max) %>% 
  kable(caption = "Beneficiaries reached by activity, by HRP version", format.args = list(big.mark = ",")) %>% 
  kable_classic_2("striped") %>% 
  column_spec(4, color = "white", background = spec_color(hrp_act_ord$`%_of_ben`[1:16], end = 0.8, direction = -1))
```


```{r dataset-cbt-bins}


format(ben %>% select(location) %>% distinct() %>% nrow(), big.mark = ",")
```

```{r}
unmatched <- fsc %>% 
    mutate(location_type = recode(location_type, 
                                  "village_ward_town" = "payam")) %>%
  filter(!is.na(location)) %>% 
  select(admin3_pcode, locations_fuzzy, location, location_type) %>%   
  left_join(locations %>%  select(location, location_code), by = "location") %>%  
  filter(is.na(location_code))

unmatched$ID <- seq.int(nrow(unmatched))

match1 <- unmatched %>% 
  select(-location_code) %>% 
  stringdist_left_join(locations %>%   
                         select(locations_fuzzy, location_code, admin3_pcode),
            by = c("locations_fuzzy", "admin3_pcode"), ignore_case = TRUE, distance_col = "distance") 

unmatched %>%
  mutate(locations_fuzzy = tolower(locations_fuzzy)) %>%
  left_join(
    match1 %>% 
      filter(admin3_pcode.distance == 0) %>% 
      group_by(locations_fuzzy.x) %>% 
      slice(which.min(locations_fuzzy.distance)) %>% 
      select(admin3_pcode = admin3_pcode.y, locations_fuzzy.y, locations_fuzzy.x),
  by = c("admin3_pcode" = "admin3_pcode", "locations_fuzzy" = "locations_fuzzy.x")) %>% 
  filter(!is.na(locations_fuzzy.y))


match2 <- unmatched %>%  
  select(-location_code) %>%
  regex_left_join(locations %>%
                       select(locations_fuzzy, admin3_pcode, location_code),
                  by = c("locations_fuzzy", "admin3_pcode")) 
  

locations %>% filter(str_detect(location, "Monastery"))
```


```{r reference-map-ggplotly, fig.height=10}

# I think you need to coalesce the states and townships with pcode3_shape or start with pcode3_shape
tsp_map <- pcode3_shape %>% 
  left_join(ben %>%
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries),
                        partners = n_distinct(implementing_partners),
                        activities = n_distinct(activity)), by = "admin3_pcode") %>% 
  left_join(pin %>%
              select(admin3_pcode, total_pop, idps, pin_new), by = "admin3_pcode") %>% 
  replace(is.na(.), 0) %>% 
  mutate(total_pop = round(total_pop)) %>% 
  st_as_sf() %>% 
  ggplot() + 
  geom_sf(size = 0.1,
          aes(fill = pin_new,
              text = paste0(township, ",", "\n",
                            state, "\n",
                            "PIN 2022: ", pin_new, "\n",
                            "total pop: ", total_pop, "\n",
                            "IDPs: ", idps, "\n",
                            "org count: ", partners, "\n",
                            "beneficiaries: ", beneficiaries))) +
  scale_fill_viridis_c(option = "mako", direction = -1) + 
  labs(fill = "PIN 2022",
       title = "Map of townships by 2022 PIN") +
  theme_void() + 
  theme(legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        plot.title = element_text(size = 12)) 

ggplotly(tsp_map, tooltip = c("text")) %>%
  layout(showlegend = TRUE, legend = list(font = list(size = 6))) %>% 
  plotly::style(hoveron = "fill") %>% 
  layout(title = list(text = paste0("Map of townships by 2022 PIN",
                                    "<br>",
                                    "<sup>",
                                    "mouse over for details; click and drag to select and zoom","</sup>")))


```
