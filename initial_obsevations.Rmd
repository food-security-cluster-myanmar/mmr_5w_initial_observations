---
title: "Initial report on the Myanmar Food Security 5Ws"
author: "Sean Ng"
date: "22/01/2021"
output: 
  html_document:
    code_download: true
    theme: readable
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: false
    collapsed: false
---


```{css, echo=FALSE}

#TOC::before {
  content: "";
  display: block;
  height: 70px;
  margin: 2em 20px 40px 20px;
  background-image: url("Myanmar_cluster_blue.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```

```{=html}
<style>
    body .main-container {
        max-width: 1280px;
    }
</style>
```

## Introduction

This report is an overview of the initial observations and analysis performed on the Food Security Cluster 5Ws data for the first three-quarters of 2021; the issues identified and analysis have been broken into large groups corresponding with the first 4 chapters -- analysis by geography, activities and modalities, partners and beneficiaries. This report ends with a brief section on next steps and an interactive reference table and reference map. 

We have endeavoured to provide actionable information and believe that releasing this report is a necessary part of jumpstarting the process of resolving the more pressing concerns identified. Further analysis is merited in several areas; and this will be undertaken once consultations with partners have been completed. 

Unless otherwise specified, beneficiary figures in this report are the number of unique beneficiaries, as opposed to beneficiary frequencies. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=9, message = FALSE, warning=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(pander)
library(janitor)
library(fuzzyjoin)
library(scales)
library(magrittr)
library(sf)
library(bookdown)
library(data.table)
library(ggsflabel)
library(patchwork)
library(plotly)
library(kableExtra)
library(DT)

theme_set(theme_light())

# disabling scientific notation
options(scipen = 100)

# pander tables all in one row
panderOptions('table.split.table', Inf)

# pander thousands separator
panderOptions("big.mark", ",")

`%out%` <- Negate(`%in%`)

# function for transposing df
transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}

# function beneficiary summaries
sum_ben <- function(df, column_var){
  
  column_var <- enquo(column_var)
  
  df %>%
    group_by(!!column_var) %>% # must add bang-bang
    summarise(beneficiaries = sum(beneficiaries)) %>% 
    arrange(desc(beneficiaries))
    
}

# reading in townships from geoadmins 
townships <- read_excel("FSC 5W 2021 - GEOADMINS_final 19.xlsx",
           sheet = "GEOADMINS") %>% 
  clean_names() %>% 
  select(admin1pcode_4:admin3pcode) %>% 
  rename(admin1_pcode = admin1pcode_4,
         admin3_pcode = admin3pcode,
         state_name   = state_5,
         township_name  = county) %>% 
  remove_empty()

# locations dataset 
locations <- bind_rows(
  
  read_excel("FSC 5W 2021 - GEOADMINS_final 19.xlsx", # payams 
             sheet = "GEOADMINS") %>% 
    clean_names() %>% 
    select(state_name:payam_code) %>% 
    rename(admin1_pcode = state_code_12,
           township_name = county_name, 
           admin3_pcode = county_code,
           location = payam_name) %>%
    remove_empty() %>% 
    mutate(location_type = paste0("payam")),
  
  read_excel("FSC 5W 2021 - GEOADMINS_final 19.xlsx", # camps
             sheet = "GEOADMINS") %>% 
    clean_names() %>% 
    select(county_name1:p_code_camp) %>% 
    rename(township_name = county_name1,
           admin3_pcode = state_code_23,
           location = camps, 
           camp_pcode = p_code_camp) %>% 
    remove_empty() %>% 
    mutate(location_type = paste0("camp")) %>% 
    left_join(townships %>% select(state_name, admin1_pcode, admin3_pcode), 
              by = c("admin3_pcode")) %>% 
    relocate(admin1_pcode) %>% 
    relocate(state_name),
  
  read_excel("FSC 5W 2021 - GEOADMINS_final 19.xlsx", # industrial zones
             sheet = "GEOADMINS") %>% 
    clean_names() %>%
    select(state_28:industrial_zones) %>% 
    rename(state_name = state_28, 
           admin1_pcode = admin1pcode_29,
           location = industrial_zones) %>%
    remove_empty() %>% 
    regex_left_join(townships %>% select(township_name, admin3_pcode),
                    by = c("location" = "township_name")) %>% 
    # replacing the NAs with 0s so the filter doesn't drop them 
    replace_na(list(township_name = 0, admin3_pcode = 0, admin1_pcode = 0)) %>%
    filter(admin3_pcode != "MMR013040") %>% # removing all the matches between Hlaingtharya and Hlaing
    filter(admin3_pcode != "MMR011006") %>% # removing all the matches between Yenangyaung and Ye
    mutate(location_type = paste0("industrial_zone"))
  
)%>%
  mutate(location_code = case_when(location_type == "camp" ~ camp_pcode,
                                   location_type == "payam" ~ payam_code,
                                   location_type == "industrial_zone" ~ NA_character_)) %>%
  mutate(locations_fuzzy = str_replace_all(location, "[[:punct:]]", ""))

# reading in 5ws
fsc <- read_excel(
  "FSC 5W 2021 - GEOADMINS_final19_(included All IP Reports)_Jan to Sep 2021_IM Combined_Final.xlsx",
                  sheet = "FSC 5W Activites",
                  skip = 5) %>% 
  janitor::clean_names() %>% 
  select(month_of_implementation:hrp_version) %>% 
  rename_all(~str_replace_all(., "^number_of_", "")) %>%
  rename_all(~str_replace_all(., "^number_", "")) %>% 
  rename(admin4_pcode = admin3_pcode, 
         admin3_pcode = admin2_pcode,
         beneficiaries = reached_beneficiaries,
         households = reached_households,
         beneficiary_type = beneficiaries_type) %>% 
  mutate(industrial_zones = replace(industrial_zones, industrial_zones == "No", NA),
         frequency = replace(frequency, frequency == "N/A", NA)) %>% 
  mutate(location = case_when(camp != "NA" ~ camp,
                              industrial_zones != "NA" ~ industrial_zones,
                              village_ward_town != "NA" ~ village_ward_town)) %>% 
  mutate(location_type = case_when(camp != "NA" ~ "camp",
                              industrial_zones != "NA" ~ "industrial_zone",
                              village_ward_town != "NA" ~ "village_ward_town")) %>%
  mutate(locations_fuzzy = str_replace_all(location, "[[:punct:]]", " ")) %>% 
  mutate(total_value_mmk = value_per_household * households) %>% 
  mutate(date = my(month_of_implementation)) %>% 
  mutate(u_ben = ifelse(unique_beneficiaries == "Yes", beneficiaries, 0)) %>% 
  mutate(state = as.character(fct_recode(state, 
                            "Kachin" = "kachin"))) %>% 
  mutate(mmk_hhd_bin = case_when(value_per_household < 10000 ~ "below_10k",
                             value_per_household >= 10000 & value_per_household <= 20000 ~ "10k_20k",
                             value_per_household > 20000 & value_per_household <= 50000 ~ "20k_50k",
                             value_per_household > 50000 & value_per_household <= 70000 ~ "50k_70k",
                             value_per_household > 70000 & value_per_household < 100000 ~ "70k_100k",
                             value_per_household >= 100000 & value_per_household < 200000 ~ "100k_200k",
                             value_per_household >= 200000 & value_per_household <= 300000 ~ "200k_300k",
                             value_per_household > 300000 ~ "above_300k",
                             TRUE ~ NA_character_),
         mmk_hhd_bin = fct_relevel(mmk_hhd_bin, c("less_than_10k", "10k_20k","20k_50k", "50k_70k", "70k_100k", "100k_200k",
                                          "200k_300k","more_than_300k")),
         frequency = recode(frequency, "monthly" = "Monthly")) %>%
  mutate(usd_hhd_bin = 
           case_when(value_per_household_usd < 10 ~ "<$10",
                     value_per_household_usd >= 10 & value_per_household_usd < 20 ~ ">=$10_<$20",
                     value_per_household_usd >= 20 & value_per_household_usd < 40 ~ ">=$20_<$40",
                     value_per_household_usd >= 40 & value_per_household_usd < 60 ~ ">=$40_<$60",
                     value_per_household_usd >= 60 & value_per_household_usd < 100 ~ ">=$60_<$100",
                     value_per_household_usd >= 100 & value_per_household_usd < 200 ~ ">=$100_<$200",
                     value_per_household_usd >= 200 ~ ">=$200",
                     TRUE ~ NA_character_),
         usd_hhd_bin = fct_relevel(usd_hhd_bin, c("<$10", ">=$10_<$20", ">=$20_<$40", ">=$40_<$60", 
                                                  ">=$60_<$100", ">=$100_<$200", ">=$200"))) %>% 
  mutate(hrp_indicator =
          recode(hrp_indicator,
          "Number of people who received food and/or cash assistance" = 
            "1. Number of people who received food and/or cash assistance",
          "Number of people who received agriculture and other livelihood support, contributing to household food security" =
            "2. Number of people who received agriculture and other livelihood support")) %>% 
  mutate(beneficiary_type = str_trim(beneficiary_type)) %>% 
  mutate(beneficiary_type = as.character(fct_recode(beneficiary_type, 
               "Rakhine stateless" = "Non-displaced stateless people in Rakhine"))) %>% 
  mutate(activity = recode(activity, 
                          "Provide monthly food baskets through in-kind assistance to acutely food insecure population in rural areas" = 
                            "Provide monthly food baskets",
                          "Provide technical training (agriculture, livestock breeding, livelihood)" = "Provide technical training",
                          "Provide support for Income Generating Activities" = "Provide support for income generation",
                          "Provide monthly cash-based transfers to acutely food insecure population in rural areas" =
                            "Provide monthly cash-based transfers",
                          "Cash for Work / Food for Assets activities" = "Cash for Work / Food for Assets",
                          "Provide fishery kits (in-kind / CBT)" = "Provide fishery kits",
                          "Provide crops & vegetables kits (in-kind / CBT)" = "Provide crops & vegetables kits",
                          "Provide livestock kits (in-kind / CBT)" = "Provide livestock kits"))


# ben dataset -- tidy format 5Ws for beneficiaries 
ben <- fsc %>% 
  filter(unique_beneficiaries == "Yes") %>%  
  select(date,
         implementing_partners, implementing_partner_type,
         state, township, village_ward_town, location, location_type, admin1_pcode, admin3_pcode,
         activity, activity_status, hrp_indicator, beneficiary_type, 
         child_male, child_female, adult_male, adult_female, elderly_male, elderly_female) %>% 
  pivot_longer(cols = child_male:elderly_female, 
               names_to = "disaggregation", values_to = "beneficiaries", values_drop_na = TRUE)
 

# reading in pin and targets
pin <- read_excel("PIN calculation Food Security Cluster_Township Breakdown.xlsx",
           sheet = "Food Sec PiN with IDPs", 
           skip = 2) %>% 
  clean_names() %>% 
  select(-c(x17, x18, x19)) %>% 
  slice(1:346) %>% 
  fill(region) %>% 
  rename(state = region,
         idps = id_ps, 
         pop_minus_idps = population_minus_id_ps, 
         pin_2022 = vulnerable_food_insecure_people_id_ps) %>%  
  filter(township != "Total") %>%  
  mutate_at(vars(pop_minus_idps:moderately_severely), ~ as.numeric(.)) %>% 
  left_join(townships, by = c("township" = "township_name")) %>% 
  select(-state) %>%  
  relocate(admin3_pcode) %>% relocate(state = state_name) %>% relocate(admin1_pcode) %>% 
  mutate(pc_vul = pin_2022 / total_pop,
         pin_2022 = round(pin_2022, digits = 0)) %>% 
  left_join(read_excel("FSC PIN and Target _combine HRP and IERP 2021.xlsx") %>%
              clean_names() %>%
              select(admin3_pcode = tsp_pcode, pin_2021 = pin, target_2021 = target), by = "admin3_pcode") %>% 
  left_join(read_excel("fs_targets_2021.xlsx") %>%
              clean_names() %>% 
              select(township = x1,
                     hrp_target_idps_2021 = internally_displaced_persons_12,
                     hrp_target_returnees_2021 = idp_returnees_resettled_locally_integrated_13,
                     hrp_target_stateless_rakhine_2021 = non_displaced_stateless_people_in_rakhine_14,
                     hrp_target_other_vulnerable_2021 = other_vulnerable_crisis_affected_people_15,
                     hrp_target_total = total_16) %>%
              left_join(townships %>%  select(township_name, admin3_pcode), by = c("township" = "township_name")) %>% 
              select(-township),
            by = "admin3_pcode") %>% 
  replace(is.na(.), 0)    


# shapefiles
pcode3_shape <- st_read("./mmr_polbnda_adm3_mimu_250k/mmr_polbnda_adm3_mimu_250k.shp", quiet = TRUE) %>% 
  rename(state = ST, 
         admin1_pcode = ST_PCODE,
         township = TS,
         admin3_pcode = TS_PCODE)

pcode1_shape <- st_read("./mmr_polbnda2_adm1_mimu_250k/mmr_polbnda2_adm1_mimu_250k.shp", quiet = TRUE) %>% 
  rename(state = ST, 
         admin1_pcode = ST_PCODE)

# for relevelling -- this is in order of beneficiaries
sr_ord <- c("Yangon", "Rakhine", "Kachin", "Shan (North)", "Ayeyarwady" , "Kayin", "Mon", "Mandalay",
            "Kayah", "Chin", "Shan (South)", "Sagaing", "Bago (East)", "Magway", "Shan (East)", "Bago (West)", "Tanintharyi")

# for printing the targets of the pin 
target_ben_2021 <- pin %>%  
  select(admin3_pcode, state, township, target_2021) %>% 
  filter(target_2021 > 0) %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(pc_reached = beneficiaries / target_2021 * 100) %>%  
  replace(is.na(.), 0) 

```


## 1. Geographical coverage

### 1.1 Comparing beneficiaries reached and 2021 PIN by state and region

A total of `r sum(ben$beneficiaries) %>% format(big.mark = ",")` unique beneficiaries have been reached across the country; this is `r round(sum(ben$beneficiaries) / sum(pin$target_2021) * 100, digits = 2)`% of the targetted `r sum(pin$target_2021) %>% format(big.mark = ",")` persons; however, not all the beneficiaries reached corresponded to areas where there were targets -- this is explored in more detail in the section on townships.

<br>


```{r barplot-state-beneficiaries-pin}
# add a third column for target for all the barplots 
pin %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries))) %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            target_2021 = sum(target_2021), 
            pin_2021 = sum(pin_2021)) %>% 
  filter(pin_2021 > 0 | beneficiaries > 0) %>% 
  pivot_longer(-state, names_to = "type", values_to = "value") %>% 
  ggplot(aes(x = fct_relevel(state, sr_ord), y = value, fill = fct_relevel(type, c("beneficiaries", "target_2021", "pin_2021")))) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(vjust = 0.4, angle = 70)) +
  theme(legend.title = element_blank()) +
  labs(x = "",
       y = "", 
       title = "Food security beneficiaries and people in need (2021)") +
   scale_y_continuous(breaks = seq(0, 2000000, by = 200000), labels = comma)
```

<br>

### 1.2 Table of beneficiaries and PIN by state and region


```{r table-beneficiaries-pin-state}
# change formulas to look at % of target and show PIN, target and achievement in the table 
pin %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            target = round(sum(target_2021), digits = 0), 
            PIN = round(sum(pin_2021), digits = 0)) %>%
  filter(beneficiaries > 0 | PIN > 0) %>% 
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         `%_target_reached` = ifelse(is.infinite(beneficiaries / target * 100), NA_real_, beneficiaries / target * 100),
         `%_target_reached` = round(`%_target_reached`, digits = 2),
         `%_of_target` = round(target / sum(target) * 100, digits = 2))  %>% 
  relocate(`%_of_ben`, .after = beneficiaries) %>% 
  relocate(`%_target_reached`, .after = target) %>% 
  relocate(`%_of_target`, .after = target) %>% 
  arrange(desc(beneficiaries)) %>% 
  kable(caption = "Beneficiaries reached and PIN by state/region", format.args = list(big.mark = ",")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

<br>

Yangon and Rakhine form both 82% of the target and 82% of the beneficiaries reached. Mandalay has has the largest difference between targets and beneficiaries reached. There were four states (Ayeyarwady, Mon, Sagaing and Magway) where beneficiaries were reached but were not included as part of the 2021 target or PIN; however, the beneficiaries reached in these areas represent less than 5% of all beneficiaries reached. Additionally, targets have been exceeded in 7 states, with Kayin having reached 684% of its target of 6,855 persons. 

However, moving forward, the PIN for 2022 is much more evenly spread across the country: with reference to the plot below, Yangon, along with Magway and Mandalay have some of the lowest proportions of vulnerable persons in relation to the total state population, meaning that careful beneficiary selection and tight vulnerability in these areas will necessary to avoid excessive inclusion errors. 

<br>

```{r barplot-pin-vul-state}
pin %>% 
  group_by(state) %>% 
  filter(state != "Nay Pyi Taw") %>% 
  summarise(pin_2022 = round(sum(pin_2022)),
            total_pop = sum(total_pop)) %>% 
  mutate(`vulnerable%` = round(pin_2022 / total_pop * 100, digits = 2),
         state = reorder(state, -`vulnerable%`))  %>% 
  ggplot(aes(x = state, y = pin_2022, fill = `vulnerable%`)) +
  geom_col() +
  geom_text(aes(label = `vulnerable%`), size = 2.5, vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5, hjust = 0.6)) +
  labs(x = "",
       y = "Number of people in need", 
       title = "2022 PIN and incidence of vulnerabilty by state and region",
       subtitle = "Vulnerability is defined here as the proportion of a population who are food insecure or are IDPs") +
  scale_y_continuous(breaks = seq(0, 2000000, by = 200000), labels = comma) +
  scale_fill_continuous(trans = "reverse")
```

<br>


### 1.3 Township-level distribution of beneficiaries

Just as the response is heavily weighted towards Yangon and Rakhine at the state and region level, the same is true at the township level as well. These 10 townships below are where 80% of beneficiaries have been reached collectively, they represent 53% of the 2021 target. In particular, Hlaingtharya has beneficiary figures that are 378% of its target. Additionally, neither Kawareik in Kayin or Kyaikmaraw in Mon were targetted as part of the 2021 PIN despite being in the top 10 townships by beneficiaries reached -- only 88.5% of beneficiaries corresponded to townships with targets.  

```{r table-top-townships-beneficiaries}
# check the paragraph text above if you rerun the report on new data 
ben %>% 
  group_by(admin3_pcode, township, state) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>% 
  left_join(pin %>% select(admin3_pcode, target = target_2021), by = "admin3_pcode") %>%
  mutate(`%_of_ben` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2),
         `%_of_target` = ifelse(is.infinite(target / sum(target, na.rm = TRUE) * 100), NA_real_, target / sum(target, na.rm = TRUE) * 100),
         `%_of_target` = round(`%_of_target`, digits = 2),
         `%reached` = ifelse(is.infinite(beneficiaries / target * 100), NA_real_, beneficiaries / target * 100),
         `%reached` = round(`%reached`, digits = 2)) %>% 
  select(-admin3_pcode) %>% 
  relocate(`%_of_ben`, .after = beneficiaries) %>% 
  relocate(state, .after = township) %>% 
  arrange(desc(beneficiaries)) %>% 
  head(10) %>% 
  pander(caption = "Top 10 townships by beneficiaries reached in 2021")
```

<br>

`r ben %>% select(township) %>% distinct() %>% nrow()` townships have been reached by food security activities in the first three-quarters of 2021. This is less than a third of the 330 townships in the country. It is also important to note that three townships -- Hpapun in Kayin, Muse in Shan (North) and Kyethi in Shan (South) have been targetted since the initial 2021 HRP, yet have not been reached by any FSC activities; 10 townships, overall, in either the HRP or IERP, have not benefitted from any FSC activities. 

Overall, `r round(sum(target_ben_2021$beneficiaries) / sum(target_ben_2021$target_2021) * 100, digits = 2)`% of the targetted population was reached. From the histogram below, we can see that overreach and under-reaching are very common at the township level -- townships are commonly clustered at around 0% reached and also at 200% reached or more. Of the 51 townships targetted in 2021; 21 townships reached more than 120% of their target, 4 reached between 100% and 119% of their target; 7 townships reached between 80% and 100% of their target; and 2 townships reached less than 80% of their target.  

<br>

```{r histogram-beneficiaries-hrp-target-reached}

pin %>%  
  select(admin3_pcode, state, township, target_2021) %>% 
  filter(target_2021 > 0) %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries)), by = "admin3_pcode") %>% 
  mutate(pc_reached = beneficiaries / target_2021 * 100) %>%  
  replace(is.na(.), 0) %>% 
  mutate(pc_reached = ifelse(pc_reached > 200, 200, pc_reached)) %>% 
  ggplot(aes(x = pc_reached)) + 
  geom_histogram(bins = 20) + 
  scale_x_continuous(breaks = seq(0, 200, by = 20)) +
  scale_y_continuous(breaks = seq(0, 10, by = 2)) + 
  labs(x = "% of 2021 HRP target reached", 
       y = "Number of townships",
       title = "Distribution of townships by percentage of 2021 HRP target reached", 
       subtitle = "Values above 200% have been lumped together at 200%")
```

<br>

### 1.4 Locations

Partners have responded in a total of `r ben %>% select(location) %>% distinct() %>% nrow()` locations across the country, with the vast majority of locations only having only one partner operating in them; the maximum number of partners in any location is 3. Of the `r fsc %>% nrow()` rows reported in the 5Ws, only `r sum(is.na(fsc$location))` did not report a specific location.

Locations are classified into three groups -- camps, industrial zones and villages/towns/wards:

```{r table-locations}

ben %>% 
  filter(!is.na(location)) %>% 
  group_by(location_type) %>% 
  summarise(locations = n_distinct(location),
            townships = n_distinct(township),
            beneficiaries = sum(beneficiaries)) %>% 
  mutate(pc_of_ben = round(beneficiaries / sum(beneficiaries) * 100, digits = 2), 
         avg_ben_per_loc = round(beneficiaries / locations, digits = 0)) %>% 
  arrange(desc(beneficiaries)) %>% 
  pander(caption = "Summary of location types")
```

<br>

The vast majority of locations are served by only one partner. Below are a series of histograms showing the variation in the number of beneficiaries by location, split by number of partners in each location:

```{r histogram-locations-by-partner}

ben %>% 
  filter(!is.na(location)) %>% 
  group_by(location, township) %>%  
  summarise(beneficiaries = sum(beneficiaries), 
            partners = n_distinct(implementing_partners), .groups = "drop") %>% 
  arrange(desc(partners)) %>% 
  ggplot(aes(x = beneficiaries)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_log10() +
  facet_wrap(~ partners) +
  labs(y = "number of locations",
       x = "beneficiaries per location", 
       title = "Histograms of beneficiaries by location",
       subtitle = "Faceted by number of partners per location")

```

<br>

The more partners operating in a given location, the higher the average number of beneficiaries; however, it should be noted that these multi-partner locations are comparatively rare:

```{r table-locations-partners}
ben %>% 
  filter(!is.na(location)) %>% 
  group_by(location, township) %>%  
  summarise(beneficiaries = sum(beneficiaries), 
            partners = n_distinct(implementing_partners), .groups = "drop") %>% 
  group_by(partners) %>% 
  summarise(locations = sum(n_distinct(location)),
            avg_beneficiaries = median(beneficiaries), .groups = "drop") %>%
  mutate(partners = recode(partners, `1` = "one_partner",
                           `2` = "two_partners",
                           `3` = "three_partners")) %>% 
 pander()

```

<br><br>



## 2. Activities and modalities

### 2.1 Progress by activity

```{r line-plot-facet-activity}
ben %>% 
  group_by(activity) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>% 
  ggplot(aes(x = date, y = cum_ben, colour = activity)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  facet_wrap(~ activity, scales = "free_y") +
  theme(legend.position = "none") +
  labs(x = "", 
       y = "cumulative beneficiaries", 
       title = "Monthly progress by activity, 2021 Q1-Q3") + 
  theme(plot.title = element_text(size = 12))

```

Partners reported their achievements across the eight 5W activities. As note, we see that the majority of the caseload for monthly cash-based transfers was established prior to 2021 (with the number of beneficiaries only increasing very incrementally across the couese of the year) -- this aligns with our understanding that many of the projects contributing to this activity were multi-year in nature and had been ongoing prior to the HRP. 

One of the difficulties of interpreting these data is that it is not always apparent where the patterns observed are reflective or changes in the field (such as changes in access, funding or staffing) or if they are instead due to partners' reporting behaviours. We note, for instance, a large jump in the number of beneficiaries for fishery its and food baskets around July 2021 -- this was due to the newly-approved addendum to the HRP. However, some of the other changes are less clear and will require careful exploration with partners. 

<br>

### 2.2 Delivery modalilties

Cash was the main delivery modality in four out of the eight activities under the Food Security Cluster, followed by "in-kind", which was predominantly employed in three. However, the in-kind modality has the highest reach, given the especially large beneficiary numbers originating from the provision of monthly food baskets. We also note several misclassifications -- small portions of monthly cash transfers have been coded as in-kind and there are in-kind food baskets coded as hybrid. It might also be worth more clearly delineating between "support for income-generating activities" and the "provision of technical training" as service delivery and support are heavily present in both.

<br>

```{r barplot-facet-activity-modality}
fsc %>% 
  filter(!is.na(delivery_modality)) %>% 
  group_by(delivery_modality, activity) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>%
  mutate(delivery_modality = recode(delivery_modality, 
                                    "Hybrid (In-kind & Cash)" = "Hybrid",
                                    "Service delivery/support" = "Services/support")) %>% 
  ggplot(aes(x = delivery_modality, y = beneficiaries, fill = activity)) +
  geom_col() +
  scale_y_continuous(labels = comma) +
  labs(x = "",
       title = "Delivery modality by activity, 2021 Q1-Q3") + 
  theme(plot.title = element_text(size = 12),
        legend.position = "none", 
        axis.text.x = element_text(angle = 40, hjust = 0.5, vjust = 0.5)) +
  facet_wrap(~ activity, scales = "free_y")

```

<br>

`r round(filter(fsc, delivery_modality == "In-kind") %>% {sum(.$beneficiaries)} / sum(fsc$beneficiaries) * 100)`% of beneficiary frequencies received support through the in-kind delivery modality; we use beneficiary frequencies here as there were several instances of modalities changing partway through an intervention: for reference, `r round(filter(fsc, delivery_modality == "In-kind") %>% {sum(.$u_ben)} / sum(fsc$u_ben) * 100)`% of beneficiaries were reached initially with in-kind interventions, meaning that there was a tendency to diversify away from in-kind support over 2021. `r round(filter(fsc, delivery_modality == "Cash") %>% {sum(.$beneficiaries)} / sum(fsc$beneficiaries) * 100)`% of beneficiary frequencies were reached by cash transfers.

<br>

```{r table-modality-frequency}
# changed to beneficiary frequencies instead of unique beneficiaries 
fsc %>% 
  group_by(delivery_modality, frequency) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>% 
  filter(beneficiaries > 0) %>% 
  pivot_wider(names_from = frequency, values_from = beneficiaries) %>% 
  adorn_totals("col", na.rm = TRUE) %>% 
  mutate(pc_of_Total = round(Total / sum(Total) * 100, digits = 2)) %>% 
  arrange(desc(Total)) %>% 
  adorn_totals("row", na.rm = TRUE) %>% 
  pander(caption = "Beneficiary frequencies by delivery modalities and frequency of distribution")

```

<br>

Regarding the table above, there is a strong argument to remove the option "other" from the 5W column `frequency` (referring to frequency of transfer/delivery) -- what exactly it connotes is unclear, as partners might elect this option for activities that occur both more and less frequently than every month; there is also the possibility that partners are just electing "other" instead of leaving the column blank. It is possible to backfill some of the "other" values from the `beneficiary_recurrency` column. This will be explored further in the chapter on beneficiaries.  

A key piece of missing information not currently captured by the 5W template is the duration of these activities -- the number of months a monthly food basket is provided can only be calculated somewhat reliably with considerable effort. The table below shows the average duration (in months) of the various activities in the `frequency` category "Monthly":

```{r table-avg-duration-activities}
fsc %>%  
  filter(frequency == "Monthly") %>% 
  group_by(activity, township, location) %>%
  summarise(recurrences = n_distinct(date), .groups = "drop") %>%
  group_by(activity) %>% 
  summarise(avg_duration_months = mean(recurrences)) %>% 
  arrange(desc(avg_duration_months)) %>% 
  pander(caption = "Average duration (in months) of monthly activities")
  
```

<br>

### 2.3 Monetary values of intervention packages per household

<br>

```{r plot-usd-hhd-bin}
fsc %>% 
  filter(unique_beneficiaries == "Yes" & !is.na(usd_hhd_bin)) %>%
  group_by(usd_hhd_bin) %>%  
  summarise(beneficiaries = sum(beneficiaries)) %>%
  mutate(`%_of_beneficiaries` = round(beneficiaries / sum(beneficiaries)* 100, digits = 2)) %>% 
  ggplot(aes(x = usd_hhd_bin, y = beneficiaries)) +
  geom_col() +
  geom_text(aes(label = `%_of_beneficiaries`), vjust = -0.5, size = 3) +
  scale_y_continuous(labels = comma, breaks = seq(0, 160000, by = 20000)) +
  labs(x = "USD value of cash transfer per household",
       y = "% of beneficiaries",
       title = "Number of beneficiaries by value of cash transfer per household")
```

<br>

The most common transfer values -- in terms of beneficiaries reached -- are between USD 10 and USD 20, though it should be noted -- and can be more clearly seen from the table below, a not insignificant number of beneficiaries (about 8%) were reached by cash transfer interventions valued at more than USD 100 per household. Please note that these monetary values were calculated only from rows with unique beneficiaries so that we are not using the cumulative sums per household. 

```{r table-usd-hhd-bin-frequency}
# reminder to redo the values in the paragaph above if you rerun this on new data 

fsc %>%  
  filter(!is.na(usd_hhd_bin) & unique_beneficiaries == "Yes") %>% 
  filter(delivery_modality %in% c("Cash", "Hybrid (In-kind & Cash)", "Voucher")) %>% 
  count(usd_hhd_bin,frequency, wt = beneficiaries) %>%
  pivot_wider(names_from = frequency, values_from = n) %>% 
  rename(transfer_value = usd_hhd_bin) %>%
  relocate(First, .after = transfer_value) %>% 
  select(-`NA`) %>% 
  adorn_totals("col", na.rm = TRUE) %>% 
  mutate(pc_of_Total = round(Total / sum(Total) * 100, digits = 2)) %>% 
  pander(caption = "Cash transfer, hybrid and voucher values per household by frequency of transfer (USD)")   
```

<br>

Next, let us take a look at household package values by activity type:

```{r barplot-facet-usd-hhd-bin-activity}
fsc %>% 
  filter(!is.na(usd_hhd_bin) & unique_beneficiaries == "Yes") %>% 
  group_by(activity, usd_hhd_bin) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  ggplot(aes(x = usd_hhd_bin, y = beneficiaries, fill = activity)) +
  geom_col() +
  scale_y_continuous(labels = comma) +
  labs(x = "") +
  labs(title = "Variation in the  per household values of intervention packages in USD", 
       subtitle = "Faceted by activity") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 90), 
        plot.title = element_text(size = 12)) +
  facet_wrap(~ activity, scales = "free_y")

```


Overall, the highest average cash transfers were from activities providing support for income generation and the lowest averages coming from monthly cash-based transfers (after discounting food baskets, where less than 1% of activities reported the package value). 

It would be fruitful to explore the provision of monthly cash-based transfers in more detail -- this activity has a very clear peak at `>=$10_<$20`. A closer look reveals that this is almost entirely due to the `r fsc %>% filter(value_per_household_usd == 10.5 & unique_beneficiaries == "Yes") %>% {sum(.$beneficiaries)} %>% format(big.mark = ",")` beneficiaries who received monthly transfers of USD 10.50/month (or MMK 15,000) per household. It is unclear whether this is a data entry error -- but what we do know is that the households that received this type of transfer were not abnormally small; it might be possible that be possible that this activity had been conceived as one singular transfer that had been split across several months. 

This should be followed up with the 7 partners who provided this transfer value to beneficiary households; they are: Save the Children, WFP, Myanmar Heart Organisation, People for People, Plan International, World Vision Myanmar and Karuna Mission Social Solidarity. 

If correct, this amount falls far below the minimum expenditure basket for food identified by the Cash Working Group, which established a floor of MMK 190,555 per household per month. Below is a table which summarises the percentage of the minimum expenditure basket is covered by the different bins we have established for the cash-transfer values:

```{r table-meb-usd-hhd-bin}
fsc %>% 
  filter(unique_beneficiaries == "Yes" & activity == "Provide monthly cash-based transfers") %>% 
  filter(!is.na(value_per_household)) %>% 
  mutate(pc_meb = value_per_household / 190555) %>% 
  group_by(usd_hhd_bin) %>% 
  summarise(avg_pc_of_meb = round(mean(pc_meb) * 100, digits = 2),
            avg_usd_month = round(mean(value_per_household_usd, na.rm = TRUE), digits = 2),
            beneficiaries = sum(beneficiaries)) %>% 
  mutate(pc_of_ben = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  pander(caption = "Monthly cash-based transfer by percentage of MEB received")

# reminder to redo values when you rerun this with new data 
  
```

Around 9% of beneficiaries of monthly cash-based transfers have received more than 50% of the value of the minimum expenditure basket for food. Notably, 15% of beneficiaries have received less than USD 10 per household per month. This underscores the importance of standardisation: beneficiaries have already received very different package amounts and there is a pressing need to collect information on whether cash transfers (and food baskets) have been designed to be full rations or are instead intended to be supplementary activities. This is key from a coordination standpoint as we cannot consider the food security needs of those who have only received supplementary transfers to have been covered.


<br><br>

## 3. Partners

Of the 51 partners of the Food Security Cluster, a total of `r fsc %>% select(implementing_partners) %>% distinct() %>% nrow()` of them classified themselves as implementing partners within the 5Ws. They are fairly evenly split themselves between HRP indicators, with `r fsc %>% filter(str_detect(hrp_indicator, "1.")) %>% select(implementing_partners) %>% distinct() %>% nrow()` contributing towards food and cash assistance and `r fsc %>% filter(str_detect(hrp_indicator, "2.")) %>% select(implementing_partners) %>% distinct() %>% nrow()` contributing towards agriculture and other livelihood support. `r ben %>% sum_ben(implementing_partners) %>% filter(beneficiaries < 10000) %>% nrow()` partners have reached less than 10,000 unique beneficiaries and the median unique beneficiaries reached by partners is `r ben %>% sum_ben(implementing_partners) %>% {median(.$beneficiaries)} %>% format(big.mark = ",")`. Below are the top 10 partners by HRP indicator. As a side note, Zigway should be considered as a vendor/supplier of WFP, and not the implementing partner -- some follow up with WFP will be necessary to rectify this.

```{r table-top-partners-by-hrp-indicator}

# reminder to redo the numbers when you rerun this with fresh data 

cbind(
  
  ben %>% 
    filter(hrp_indicator == "1. Number of people who received food and/or cash assistance") %>% 
    group_by(implementing_partners) %>% 
    summarise(beneficiaries = sum(beneficiaries)) %>% 
    arrange(desc(beneficiaries)) %>% 
    rename(`1. Number of people who received food and/or cash assistance` = beneficiaries,
           `Partners HRP indicator1` = implementing_partners) %>% 
    head(10),
  
  ben %>% 
    filter(hrp_indicator == "2. Number of people who received agriculture and other livelihood support") %>% 
    group_by(implementing_partners) %>% 
    summarise(beneficiaries = sum(beneficiaries)) %>% 
    arrange(desc(beneficiaries)) %>% 
    rename(`2. Number of people who received agriculture and other livelihood support` = beneficiaries,
           `Partners HRP indicator2` = implementing_partners) %>% 
    head(10)
  
) %>% 
  add_column(` ` = " ") %>% 
  relocate(` `, .after = `1. Number of people who received food and/or cash assistance`) %>% 
  pander(caption = "Top 10 partners by beneficiaries reached, by HRP indicator")

```

<br>

### 3.1 Distribution of partners by beneficiaries and geographic reach

Whilst there is quite a bit of variation in the number of beneficiaries reached, we can see that partners' geographic footprints are -- on the whole -- quite limited. Only `r ben %>% group_by(implementing_partners) %>% summarise(townships = n_distinct(admin3_pcode)) %>% filter(townships > 10) %>% nrow()` partners have a presence in more than 10 townships, with only `r ben %>% group_by(implementing_partners) %>% summarise(townships = n_distinct(admin3_pcode)) %>% filter(townships > 5) %>% nrow()` being present in more than 5 townships. 79% of our partners (clustered along the bottom of the chart) are present in 5 or less townships. This distribution of partners is an impediment to a countrywide response and it is imperative to understand how best to incentivise partners to expand their footprints.

```{r plotly-scatter-partners-reach}
# reminder to recalculate the 79% above if you rerun the data 
partner_scatter <- ben %>% 
  group_by(implementing_partners) %>% 
  summarise(states = n_distinct(admin1_pcode),
            townships = n_distinct(admin3_pcode),
            beneficiaries = sum(beneficiaries)) %>% 
  arrange(desc(states)) %>% 
  ggplot(aes(x = beneficiaries, y = townships, text = implementing_partners)) +  
  geom_point(aes(size = beneficiaries)) +
  scale_x_continuous(trans = "log", labels = comma, breaks = c(0, 100, 1000, 10000, 100000, 300000)) +
  scale_y_continuous(breaks = seq(0, 30, 5)) +
  labs(x = "Number of beneficiaries",
       y = "Number of townships",
       title = "Plot of beneficiaries and townships reached, by implementing partner") 
# for some reason, removing this messes with the alignment of the plot

ggplotly(partner_scatter) %>%
  config(displayModeBar = FALSE) %>% 
  layout(title = list(text = paste0("Plot of beneficiaries and townships reached, by implementing partner",
                                    "<br>", 
                                    "<sup>",
                                    "mouse over for details",
                                    "</sup>")))
  
```

<br>

### 3.2 Map of number of partners and 2022 people in need by state/region


```{r has-partner-dataset}
has_partner <- pin %>% select(state, admin3_pcode, township, pin_2022) %>% 
  left_join(ben %>%  
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries), 
                        partners = n_distinct(implementing_partners)), by = "admin3_pcode") %>% 
  replace(is.na(.), 0) %>% 
  mutate(has_partner = ifelse(partners == 0, FALSE, TRUE)) %>% 
  group_by(has_partner) %>% 
  summarise(pin_2022 = sum(pin_2022),
            townships = n()) %>% 
  adorn_percentages("col") %>% 
  mutate(pin_2022 = round(pin_2022 * 100, digits = 2),
         townships = round(townships * 100, digits = 2))

```

Food Security Cluster partners are not well-positioned to meet the needs of the 2022 population in need. Partners are largely concentrated in Kachin, Rakhine and Yangon, with no partners present in Tanintharyi and Bago (West) and only one partner present in Magway, Bago (East) and Shan (East). The number of partners in Ayeryawady is also quite disproportionate with the number of people in need in that region. 

Overall, `r round(has_partner %>% filter(has_partner == FALSE) %>% pull(townships))`% of townships, containing `r round(has_partner %>% filter(has_partner == FALSE) %>% pull(pin_2022))`% of the 2022 PIN, do not have any partners present. This lack of nationwide coverage will be one of the most important constraints that the FSC will face in meeting the 2022 needs of vulnerable, food insecure persons and IDPs -- and resolving this will necessitate increasing partner coverage and finding new partners the cluster.

```{r map-partners-pin-township, fig.height=10}
# play with geom_line for the interactive reference map -- maybe you can get the outlines to be in different colours

ben %>% 
  group_by(admin3_pcode) %>% 
  summarise(partners = n_distinct(implementing_partners)) %>% 
  right_join(pcode3_shape, by = "admin3_pcode") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = partners), size = 0.1) +
  scale_fill_gradient(trans = "reverse", breaks = c(1, 3, 5, 7, 9)) +
  theme_void() + 
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.key.size = unit(0.7, 'cm')) +
  labs(title = "Map of number of partners by township") +

pin %>% 
  group_by(admin3_pcode) %>% 
  summarise(PIN = sum(pin_2022)) %>% 
  mutate(PIN = round(PIN, digits = 0), 
         PIN = recode(PIN, 
                      '0' = NA_real_)) %>%
  right_join(pcode3_shape, by = "admin3_pcode") %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = PIN), size = 0.1) +
  scale_fill_gradient(trans = "reverse", breaks = c(10000, 50000, 100000, 150000, 180000)) +
  theme_void() +
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.key.size = unit(0.7, 'cm')) +
  labs(title = "Map of 2022 PIN by township")

```



### 3.3 Reporting organisations

There are `r fsc %>% distinct(reporting_organization, implementing_partners) %>% nrow()` combinations between reporting organisations and implementing partners, `r fsc %>% distinct(reporting_organization, implementing_partners) %>% filter(reporting_organization == implementing_partners) %>% nrow()` of which are instances where the reporting organisation and the implementing partner are the same organisation; once these are filtered out, all the remaining implementing partners correspond to just `r fsc %>% filter(reporting_organization != implementing_partners) %>% distinct(reporting_organization) %>% nrow()` reporting organisations:

```{r table-reporting-organisation}
fsc %>% 
  filter(reporting_organization != implementing_partners) %>% 
  group_by(reporting_organization) %>% 
  summarise(implementing_partners = n_distinct(implementing_partners)) %>% 
  arrange(desc(implementing_partners)) %>% 
  pander(caption = 'Number of implementing partners by reporting organisation')
  
```

Regarding questions of membership, it would be safe to say that all partners who reported in the 5Ws -- be they reporting organisations or implementing partners -- in addition to strategic partners and partners who aid in analysis who are not represented in the 5Ws, are FSC partners. However, for this report, we have used `implementing_partners` for most of the analysis as, by their nature, reporting organisations do not have a field presence. As a side note, FAO has not classified itself as an implementing partner, having reported no activities that were directly implemented by them. 

<br>

### 3.4 Types of partners

```{r table-implementing-partner-type}
fsc %>% 
  group_by(implementing_partner_type, implementing_partners) %>%  
  summarise(beneficiaries = sum(beneficiaries), 
            townships = n_distinct(admin3_pcode),
            states = n_distinct(admin1_pcode), .groups = "drop") %>% 
  group_by(implementing_partner_type) %>% 
  summarise(avg_beneficiaries = mean(beneficiaries),
            avg_townships = mean(townships), 
            avg_states = mean(states), .groups = "drop") %>%  
  pander(caption = "Average reach by implementing partner type")
```

There is no real difference between the average numbers of beneficiaries reached by INGOs and NNGOs; however, the geographical reach of INGOs is markedly greater, perhaps due to the much tighter geographical focus of several community-based organisations. There is only one agency in the "UN" category for implementing partner type -- WFP.

The only notable thing about the `donor` column is its incompleteness, which is understandable -- only `r round(sum((!is.na(fsc$donor))) / nrow(fsc) * 100, digits = 0)`% (representing only 10% of all reported beneficiary frequencies) of the rows are filled. Additionally, we also observe a number of errors, including cases where multiple donors have been combined into one row as well as numerous instances where WFP, FAO and UN WOMEN were classified as donors as opposed to reporting organisations. Not much useful analysis can be extracted from this column at present.

<br><br>

## 4. Beneficiaries

### 4.1 Beneficiary disaggregations

Currently, in the 5Ws, the vast majority of beneficiary diasaggregations have been backfilled from census data and do not, consequently, provide an accurate picture of the population that have been reached bu Food Security interventions. It is not possible to determine how far reality diverges from what has been reported so far -- meaning that we also cannot determine if there has been any bias in beneficiary selection and targetting. It is imperative to begin collecting disaggregated beneficiary data from partners. 

It is entirely possible that partners are collecting this data -- disaggregated beneficiary data is one of the most common data required for internal and external reporting -- and that it is merely necessary to work with partners to wrangle their data into the 5W format. However, the capacities of partners to disaggregate beneficiary data should be investigated by the cluster and is an important issues that should be brought up in te next plenary session. 

<br>

### 4.2 Types of beneficiaries

```{r beneficiary-type-dataset}
ben_type <- fsc %>% 
  filter(!is.na(beneficiary_type) & unique_beneficiaries == "Yes") %>% 
  group_by(beneficiary_type) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>%
  adorn_percentages(denominator = "col", na.rm = TRUE) %>% 
  mutate(beneficiaries = round(beneficiaries * 100, digits = 2))
```


The states and sub-regions in which we are working the most with IDPs are Bago (East), Kachin, Chin, Shan (North) and Kayah. Overall, `r ben_type %>% filter(beneficiary_type == "Host/local Community") %>% pull(beneficiaries)`% of beneficiaries are from the host/local community, `r ben_type %>% filter(beneficiary_type == "Rakhine stateless") %>% pull(beneficiaries)`% are stateless persons from Rakhine and `r ben_type %>% filter(beneficiary_type == "Internally Displaced") %>% pull(beneficiaries)`% are IDPs. Returnees are the rarest type of beneficiary reached, forming only `r ben_type %>% filter(beneficiary_type == "Returnees") %>% pull(beneficiaries)`% of all beneficiaries reached. Each row in the table below shows the percentage of each beneficiary type within each state/region. 

```{r table-beneficiary-types-state}
fsc %>% 
  filter(!is.na(beneficiary_type) & unique_beneficiaries == "Yes") %>% 
  group_by(state, beneficiary_type) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>%  
  pivot_wider(names_from = beneficiary_type, values_from = beneficiaries) %>% 
  adorn_totals(where = "row", na.rm = TRUE) %>% 
  adorn_percentages(denominator = "row", na.rm = TRUE) %>% 
  mutate_at(vars(`Host/local Community`, `Internally Displaced`, `Returnees`, `Rakhine stateless`), 
            .funs = list(~ round(. * 100, digits = 2))) %>% 
  replace_na(list(`Host/local Community` = 0, `Internally Displaced` = 0, `Returnees` = 0, `Rakhine stateless` = 0)) %>%  
  left_join(fsc %>% 
              filter(!is.na(beneficiary_type) & unique_beneficiaries == "Yes") %>%
              group_by(state) %>%
              summarise(beneficiaries = sum(beneficiaries)), by = "state") %>% 
  kable(caption = "Beneficiary types by state/region", format.args = list(big.mark = ",")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

<br>

Compared to only the 2021 HRP targets (as the IERP does not have breakdowns of the target by beneficiary type), we can see that whilst targets have been mostly exceeded, neither the targets for returnees/resettled in Kachin or Shan (North) nor targets for IDPs in Rakhine or Kayin have been met. Interestingly, for Rakhine, the targets for the host/local population have been greatly exceeded. In Bago (East), Chin, and particularly Shan (North), the targets for IDPs have been greatly exceeded, in comparison to the 2021 HRP targets:

```{r table-beneficiary-type-reached-hrp-target}
# reminder to check the text in the paragraph above when you rerun the report with data
pin %>%
  filter(hrp_target_total > 0) %>% 
  select(state, admin3_pcode, hrp_target_idps_2021, hrp_target_returnees_2021, hrp_target_stateless_rakhine_2021, 
                     hrp_target_other_vulnerable_2021, hrp_target_total) %>% 
  left_join(fsc %>% 
            filter(!is.na(beneficiary_type) & unique_beneficiaries == "Yes") %>% 
  group_by(admin3_pcode, beneficiary_type) %>% 
  summarise(beneficiaries = sum(beneficiaries), .groups = "drop") %>%
  pivot_wider(names_from = beneficiary_type, values_from = beneficiaries) %>% 
  mutate(total_beneficiaries = rowSums(across(where(is.numeric)), na.rm = TRUE)), by = "admin3_pcode") %>% 
  clean_names() %>%
  replace(is.na(.), 0) %>% 
  group_by(state) %>% 
  summarise_at(vars(hrp_target_idps_2021:total_beneficiaries), ~sum(.)) %>% 
  mutate(host_local_pc = host_local_community / hrp_target_other_vulnerable_2021 * 100, 
         idp_pc = internally_displaced / hrp_target_idps_2021 * 100,
         returnees_pc = returnees / hrp_target_returnees_2021 * 100,
         rakhine_stateless_pc = rakhine_stateless / hrp_target_stateless_rakhine_2021 * 100,
         total_pc = total_beneficiaries / hrp_target_total * 100) %>% 
  select(state, host_local_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc) %>%
  mutate_at(vars(host_local_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc), ~ replace(., is.nan(.), NA)) %>%
  mutate_at(vars(host_local_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc), ~ replace(., is.infinite(.), NA)) %>%
  mutate_at(vars(host_local_pc, idp_pc, returnees_pc, rakhine_stateless_pc, total_pc), ~ round(., digits = 2)) %>%
  rename(`host_local%` = host_local_pc,
         `idp%` = idp_pc,
         `returnees%` = returnees_pc,
         `rakhine_stateless%` = rakhine_stateless_pc,
         `total%` = total_pc) %>% 
  pander(caption = "Percentage of 2021 HRP target reached by beneficiary type")

  
```
 
<br>

Stateless persons from Rakhine have the largest average household sizes, and the largest variations in household size. The thick bar in the middle of each box shows the average household size for each beneficiary type -- this value is also shown in the text label below the line. The lower and upper borders of each box indicate the values for the 25th and 75th percentiles respectively. For instance, we can see that households at the 25th percentile of households in host/local communities have only one member and households that have around 5 members have more members than 75% of all the households in that group. Outliers are marked by dots. We note a lot of potential data entry errors where less than one person per household have been recorded. 

<br>

```{r boxplot-household-size-beneficiary-type}

# this is for the labels for the boxplot
hhd_labs <- fsc %>%  
  filter(beneficiary_type != "NA") %>% 
  group_by(beneficiary_type) %>%
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE),
            households = sum(households, na.rm = TRUE)) %>% 
  mutate(avg_hhd_size = round(beneficiaries / households, digits = 2))  
 

# for some reason, the mutate fct_reorder is not working
# you figured this out but have neglected to write the answer here 
 
fsc %>% 
  filter(beneficiary_type != "NA") %>% 
  group_by(beneficiary_type) %>% 
  mutate(avg_hhd_size = beneficiaries / households, na.rm = TRUE) %>% 
  ggplot(aes(x = fct_reorder(beneficiary_type, avg_hhd_size), y = avg_hhd_size)) + 
  geom_boxplot() +
  geom_text(data = hhd_labs, aes(label = avg_hhd_size), size = 2.5) +
  scale_y_continuous(breaks = seq(0, 14, 2), limits = c(0,14)) +
  labs(x = "", 
       y = "Average household size",
       title = "Average household size by beneficiary types")

```


<br>

### 4.3 Beneficiaries by activity frequency

The categories "First" and "Monthly" in the frequency column do not seem to be filled as intended, as can be seen from the plot below:

<br>

```{r line-plot-first-monthly}

fsc %>% 
  filter(frequency == "First" | frequency == "Monthly") %>% 
  group_by(date, frequency) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  ggplot(aes(x = date, y = beneficiaries, colour = frequency)) + 
  geom_line(size = 1) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  labs(x = "",
       y = "Beneficiaries",
       title = "Beneficiaries reached by frequency -- comparison between 'First' and 'Monthly'") +
  theme(plot.title = element_text(size = 12))

```

The assumption for these categories is that the first instance of a beneficiary receiving support (as part of a continuing monthly support package) would fall under the category "First" and every subsequent time they received support, it would be under "Monthly". 

But we can see that this is not the case -- monthly beneficiaries predated the use of the "First" category by at least four months; furthermore, the spike in first-time beneficiaries in May 2021 was not accompanied by any increase in monthly beneficiaries in the subsequent months -- in fact, there was a decline in monthly beneficiaries. Complicating all this is that we are not sure which of the beneficiaries track beneficiaries in a comprehensive manner i.e. with a beneficiary database and beneficiary ID cards. All this indicates that -- after confirming this with partners -- we should abandon the "First" category and recode these entries as "One-off".


<br>

### 4.4 Gaps in monthly programming

```{r table-gaps-months}
# I feel like this is the most inefficient way to do this; still works, though 
gap_months <- fsc %>% 
  filter(frequency == "Monthly" & beneficiaries > 0) %>% 
  group_by(date, implementing_partners, activity, state, township, location) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  pivot_wider(names_from = date, values_from = beneficiaries) %>% 
  unnest() %>% 
  ungroup() %>% 
  mutate(recurrences = rowSums(!is.na(select(., -implementing_partners, -activity, -state, -township, -location))),
         ben_max = pmax(`2021-01-01`, `2021-02-01`, `2021-03-01`, `2021-04-01`, `2021-05-01`, `2021-06-01`,
                              `2021-07-01`, `2021-08-01`, `2021-09-01`, na.rm = TRUE)) %>%
  pivot_longer(cols = c(`2021-01-01`, `2021-02-01`, `2021-03-01`, `2021-04-01`, `2021-05-01`, `2021-06-01`,
                              `2021-07-01`, `2021-08-01`, `2021-09-01`), names_to = "date", values_to = "beneficiaries") %>% 
  mutate(distribution = ifelse(is.na(beneficiaries), "n", "y")) %>% 
  select(-beneficiaries) %>% 
  pivot_wider(names_from = date, values_from = distribution) %>% 
  mutate(gaps = paste0(`2021-01-01`, `2021-02-01`, `2021-03-01`, `2021-04-01`, `2021-05-01`, `2021-06-01`,
                              `2021-07-01`, `2021-08-01`, `2021-09-01`)) %>% 
  mutate(gap_months = case_when(str_detect(gaps, "ynnnnnny") ~ 6,
                                str_detect(gaps, "ynnnnny") ~ 5,
                                str_detect(gaps, "ynnnny") ~ 4,
                                str_detect(gaps, "ynnny") ~ 3,
                                str_detect(gaps, "ynny") ~ 2,
                                str_detect(gaps, "yny") ~ 1,
                                TRUE ~ 0)) 

## commented out, but this was just to get the number of townships with gaps per state
# gap_months %>% 
#   filter(recurrences > 1) %>% 
#   group_by(state, township) %>% 
#   summarise(avg_gap = mean(gap_months), 
#             beneficiaries = sum(ben_max)) %>% 
#   arrange(desc(avg_gap)) %>%
#   filter(avg_gap > 0) %>% 
#   group_by(state) %>%
#   summarise(townships = n_distinct(township))

gap_months %>% 
  filter(recurrences > 1) %>% 
  group_by(gap_months) %>% 
  summarise(locations = n_distinct(location),
            townships = n_distinct(township),
            beneficiaries = sum(ben_max)) %>% 
  mutate(pc_of_ben = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  pander(caption = "Number of beneficiaries and locations by duration of gaps in implementation")

# reminder to check the paragraph below when you rerun the report

```

75% of beneficiaries experienced no gaps in monthly programming and very long gaps of 4 or 5 months are quite rare; of the beneficiaries who did experience gaps in monthly coverage, most experienced gaps of 1-2 months. The 10 townships which experienced the longest average gaps between "monthly" activities were: Mohnyin, Myitkyina, Hpakant, Mogaung, Chipwi and Waingmaw in Kachin; Shwepyithar in Yangon; Demoso and Loikaw in Kayah; and Kutkai in Shan. Overall, 12 townships in Kachin experienced gaps in the implementation of monthly activities; 6 in Rakhine; 2 each in Ayeyarwady, Kayah and Shan; and 1 in Yangon. It should be explored whether the delays in these areas were due to access issues or other other constraints. 

There are 167 entries coded as being implemented on a monthly basis that have not recurred -- that is, they have only been implemented once: we should check with partners if these are merely the first instances or if they are errors in data entry or if there have been issues with access, security or funding. 

<br>

### 4.5 Potential for post-distribution monitoring

The table below shows activities which have been implemented for 6 months or more, the number of locations they were implemented in and the number of unique beneficiaries reached by activities meeting these criteria. The possibility of joint monitoring -- or at least the joint review and analysis of monitoring data -- will be explored, in consultation with these partners. The rationale being that 6 months of implementation should be a long enough period of time to make impact monitoring feasible; additionally, joint monitoring will be further facilitated by the similarity of these activities, almost all of which are recurrent cash transfers or distributions of food baskets. 


```{r table-monthly-activities-6-9-months, warning=FALSE}

fsc %>% 
  filter(frequency == "Monthly" & beneficiaries > 0) %>% 
  select(date, implementing_partners, activity, township, location, beneficiaries) %>% 
  pivot_wider(names_from = date, values_from = beneficiaries) %>% 
  unnest() %>% 
  mutate(recurrences = rowSums(!is.na(select(., -implementing_partners, -activity, -township, -location))),
         beneficiaries = pmax(`2021-01-01`, `2021-02-01`, `2021-03-01`, `2021-04-01`, `2021-05-01`, `2021-06-01`,
                              `2021-07-01`, `2021-08-01`, `2021-09-01`, na.rm = TRUE)) %>% 
  filter(recurrences > 5) %>% 
  group_by(activity) %>% 
  summarise(partners = n_distinct(implementing_partners),
            locations = n(), 
            beneficiaries = sum(beneficiaries)) %>% 
  pander(caption = "Number of unique beneficiaries which have received at least 6 months of recurrent food security support")

```



The partners which have implemented activities fitting these criteria are WFP, Karuna Mission Social Solidarity, World Vision Myanmar, Myanmar Open Heart Development Organisation, People for People and Plan International for monthly cash transfers; World Vision Myanmar, Myanmar Open Heart Development Organisation, Action for Green Earth, People Hope Community Development (PHCD), Together for Sustainable Development, Karuna Mission Social Solidarity and WFP for monthly food baskets; and the Da-Nu National Affairs Organisation (DNAO) for technical training. 



<br><br>

## 5. Next steps

1.  Communicate to partners that Yangon is severely oversubscribed in comparison to the rest of the country, above all in the townships of Hlaingtharya, Dagon Myothit (Seikkan), and Dala.

2.  Collect existing intervention packages from partners in order to begin the process of standardisation and to support the review of food baskets for their caloric and nutritional value. Perform additional analysis to understand if beneficiaries in close proximity to each other have received widely divergent package values. Additionally, speak with partners to understand why cash transfer values vary by so much even within the same activity implemented by the same partner. 

3. Revisit areas which have only received smaller supplementary transfers -- a transfer of around USD 10 per household per month cannot be considered to have covered the food security needs for that area -- other partners may be necessary to cover the gap. 

4. Advocate for the expansion of partners' geographic footprints to reach the remaining 213 townships which have yet to benefit from any FSC activities. The effects of the current crisis in Myanmar have not been determined by an epicentre or a stormpath and there is no programmatic rationale for the response to be so uneven. This advocacy should be targetted at the ICCG, Cluster partners, other Clusters and at donors. 

5. Collect 5W data from other clusters so that multi-sector coverage may be reviewed. Clean and process conflict data so that it may be cross-referenced with partners' coverage. 

6. Work with partners to determine their current capacities to submit age and sex-disaggregated beneficiary data. Develop a workplan to ensure that they can meet reporting requirements. 

7. Solicit monitoring reports from partners and explore the possibility of joint monitoring. 

8. Revise the 5W template -- in consultation with partners -- in order to address the data collection issues identified. 

<br><br>

## 6. Reference table -- township-level

```{r datatable-townships-reference}
# add in target
pin %>% 
  select(state, township, admin3_pcode, total_pop, PIN_2022 = pin_2022, IDPs = idps) %>% 
  mutate(total_pop = round(total_pop, digits = 0)) %>% 
  left_join(fsc %>%
              select(activity, partners = implementing_partners, beneficiaries = u_ben, beneficiary_frequencies = beneficiaries,
                     location, admin3_pcode) %>% 
              group_by(admin3_pcode) %>% 
              summarise(partners = n_distinct(partners),
                        beneficiaries = sum(beneficiaries),
                        beneficiary_frequencies = sum(beneficiary_frequencies),
                        locations = n_distinct(location)), by = "admin3_pcode") %>%
  replace_na(list(partners = 0, beneficiaries = 0, beneficiary_frequencies = 0, locations = 0)) %>% 
  relocate(admin3_pcode, .after = IDPs) %>% 
  arrange(desc(beneficiaries)) %>% 
  datatable(filter = "top", options = list(pageLength = 10, scrollX = TRUE,
                                           initComplete = htmlwidgets::JS(
          "function(settings, json) {",
          paste0("$(this.api().table().container()).css({'font-size': '", "8.5pt", "'});"),
          "}")
       ) 
     ) 
```

<br><br>

## 7. Reference map -- township-level

```{r reference-map-ggplotly, fig.height=10}

# I think you need to coalesce the states and townships with pcode3_shape or start with pcode3_shape
tsp_map <- pcode3_shape %>% 
  left_join(ben %>% 
              group_by(admin3_pcode) %>% 
              summarise(beneficiaries = sum(beneficiaries),
                        partners = n_distinct(implementing_partners),
                        activities = n_distinct(activity)), by = "admin3_pcode") %>% 
  left_join(pin %>% 
              select(admin3_pcode, total_pop, idps, pin_2022), by = "admin3_pcode") %>% 
  replace(is.na(.), 0) %>% 
  st_as_sf() %>% 
  ggplot() + 
  geom_sf(size = 0.1,
          aes(fill = pin_2022,
              text = paste0(township, ",", "\n",
                            state, "\n",
                            "PIN 2022: ", pin_2022, "\n",
                            "org count: ", partners, "\n",
                            "act count: ", activities, "\n",
                            "beneficiaries: ", beneficiaries))) +
  scale_fill_viridis_c(option = "turbo", trans = "log10") + 
  labs(fill = "PIN 2022",
       title = "Map of townships by 2022 PIN") +
  theme_void() + 
  theme(legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        plot.title = element_text(size = 12)) 

ggplotly(tsp_map, tooltip = c("text")) %>%
  layout(showlegend = TRUE, legend = list(font = list(size = 6))) %>% 
  plotly::style(hoveron = "fill") %>% 
  layout(title = list(text = paste0("Map of townships by 2022 PIN",
                                    "<br>",
                                    "<sup>",
                                    "mouse over for details; click and drag to select and zoom","</sup>")))
```

